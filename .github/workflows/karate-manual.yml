name: ğŸš€ Karate API Tests - Manual

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de pruebas a ejecutar (ej: @login, @security)"
        required: true
        type: string
      ambiente:
        description: "Ambiente a ejecutar (DEV o QA)"
        required: true
        type: choice
        options:
          - DEV
          - QA
        default: QA
      correo:
        description: "Correo donde llegarÃ¡n las notificaciones"
        required: true
        type: string

jobs:
  run-karate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:

      # ---------- 1. Checkout ----------
      - name: ğŸ“¥ Checkout del repositorio
        uses: actions/checkout@v4

      # ---------- 2. JDK ----------
      - name: â˜• Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # ---------- 3. NotificaciÃ³n antes ----------
      - name: âœ‰ï¸ Notificar INICIO de ejecuciÃ³n
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "ğŸ”µ Inicio de ejecuciÃ³n Karate â€“ Tag: ${{ github.event.inputs.tag }}"
          body: |
            Hola,

            Se iniciarÃ¡ la ejecuciÃ³n de pruebas Karate.
            â€¢ Tag: ${{ github.event.inputs.tag }}
            â€¢ Ambiente: ${{ github.event.inputs.ambiente }}
            â€¢ Fecha/Hora: $(date)

            Te notificarÃ© nuevamente al finalizar las pruebas.

      # ---------- 4. Instalar dependencias ----------
      - name: ğŸ“¦ Instalar dependencias
        run: mvn clean install -DskipTests

      # ---------- 5. Ejecutar pruebas ----------
      - name: ğŸ§ª Ejecutar pruebas Karate con tag
        id: karate
        run: |
          echo "karate_failed=false" >> $GITHUB_OUTPUT
          mvn test -Dkarate.options="--tags ${{ github.event.inputs.tag }}" -Dkarate.env=${{ github.event.inputs.ambiente }} || echo "karate_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      # ---------- 6. Listar reportes ----------
      - name: ğŸ“„ Listar reportes
        if: always()
        run: ls -R target || echo "No existe carpeta target"

      # ---------- 7. Subir artefactos ----------
      - name: ğŸ“¤ Subir reportes de Karate
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: karate-report
          path: target/
          retention-days: 14

      # ---------- 8. Crear reporte si no existe ----------
      - name: ğŸ›  Crear reporte si no existe
        if: always()
        run: |
          mkdir -p target/karate-reports
          if [ ! -f target/karate-reports/karate-summary.html ]; then
            echo "<h1>No se generÃ³ el reporte porque hubo fallas en la ejecuciÃ³n</h1>" > target/karate-reports/karate-summary.html
          fi

      # ---------- 9. NotificaciÃ³n final ----------
      - name: âœ‰ï¸ Notificar FIN de ejecuciÃ³n + Adjuntar reporte
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "ğŸŸ¢ Resultados Karate â€“ Tag: ${{ github.event.inputs.tag }}"
          html_body: |
            <h2>Resultados de pruebas Karate</h2>
            <p><b>Tag:</b> ${{ github.event.inputs.tag }}</p>
            <p><b>Ambiente:</b> ${{ github.event.inputs.ambiente }}</p>
            <p><b>Estado:</b> <strong>
              ${{ steps.karate.outputs.karate_failed == 'true' && 'FAILED âŒ' || 'PASSED âœ…' }}
            </strong></p>
            <p><b>Fecha/Hora:</b> $(date)</p>
            <p>Se adjunta el reporte detallado de pruebas.</p>
          attachments: |
            target/karate-reports/karate-summary.html
            target/karate-reports/*.html
            target/surefire-reports/
