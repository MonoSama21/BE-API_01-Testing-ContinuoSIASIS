name: ğŸš€ Karate API Tests - Manual

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de pruebas a ejecutar (ej: @login, @security)"
        required: true
        type: string
      ambiente:
        description: "Ambiente a ejecutar (DEV o QA)"
        required: true
        type: choice
        options:
          - DEV
          - QA
        default: QA
      email:
        description: "Correo a notificar"
        required: true
        type: string

jobs:
  run-karate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:

      # -------------------------------------------
      # 1. NotificaciÃ³n ANTES de la ejecuciÃ³n
      # -------------------------------------------
      - name: ğŸ“§ Notificar inicio de ejecuciÃ³n
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          to: ${{ github.event.inputs.email }}
          from: ${{ secrets.SMTP_USERNAME }}
          subject: "âš ï¸ Inicio de ejecuciÃ³n Karate â€“ Tag: ${{ github.event.inputs.tag }}"
          html_body: |
            <h2>Inicio de ejecuciÃ³n de pruebas Karate</h2>
            <p><b>Tag:</b> ${{ github.event.inputs.tag }}</p>
            <p><b>Ambiente:</b> ${{ github.event.inputs.ambiente }}</p>
            <p>ğŸ“… <b>Fecha/Hora:</b> $(date)</p>
            <p>Te avisarÃ© nuevamente cuando finalicen las pruebas.</p>

      # 2. Checkout
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # 3. Java
      - name: â˜• Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 4. Dependencias
      - name: ğŸ“¦ Instalar dependencias
        run: mvn clean install -DskipTests

      # 5. Ejecutar Karate
      - name: ğŸ§ª Ejecutar pruebas
        run: mvn test -Dkarate.options="--tags ${{ github.event.inputs.tag }}" -Dkarate.env=${{ github.event.inputs.ambiente }}

      # 6. Crear ZIP Ãºnico de TODOS los reportes
      - name: ğŸ“¦ Comprimir reportes en ZIP
        run: |
          zip -r karate-report.zip target/

      # 7. Subir ZIP como artefacto
      - name: ğŸ“¤ Subir reporte ZIP como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: karate-report
          path: karate-report.zip
          retention-days: 14

      # -------------------------------------------
      # 8. NotificaciÃ³n FINAL con ZIP adjunto
      # -------------------------------------------
      - name: ğŸ“§ Notificar finalizaciÃ³n
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          to: ${{ github.event.inputs.email }}
          from: ${{ secrets.SMTP_USERNAME }}
          subject: "ğŸŸ¢ Resultados Karate â€“ Tag: ${{ github.event.inputs.tag }}"
          html_body: |
            <h2>FinalizÃ³ la ejecuciÃ³n de pruebas Karate</h2>
            <p><b>Tag:</b> ${{ github.event.inputs.tag }}</p>
            <p><b>Ambiente:</b> ${{ github.event.inputs.ambiente }}</p>
            <p><b>Estado:</b> <strong>${{ job.status }}</strong></p>
            <p>ğŸ“… <b>Fecha/Hora:</b> $(date)</p>
            <p>Se adjunta el reporte completo en formato ZIP.</p>
          attachments: karate-report.zip
