name: ğŸš€ Karate API Tests - Manual

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de pruebas a ejecutar (ej: @login, @security)"
        required: true
        type: string
      ambiente:
        description: "Ambiente a ejecutar (DEV o QA)"
        required: true
        type: choice
        options:
          - DEV
          - QA
        default: QA
      correo:
        description: "Correo donde se enviarÃ¡ la notificaciÃ³n"
        required: true
        type: string

jobs:
  run-karate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:

      # ---------- 0. NotificaciÃ³n antes ----------
      - name: âœ‰ï¸ Enviar notificaciÃ³n ANTES de ejecutar pruebas
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âš ï¸ Inicio de ejecuciÃ³n Karate â€“ Tag: ${{ github.event.inputs.tag }}"
          to: ${{ github.event.inputs.correo }}
          from: "GitHub Actions <${{ secrets.SMTP_USERNAME }}>"
          body: |
            Hola,

            Se iniciarÃ¡ la ejecuciÃ³n de pruebas Karate.
            â€¢ Tag: ${{ github.event.inputs.tag }}
            â€¢ Ambiente: ${{ github.event.inputs.ambiente }}
            â€¢ Fecha/Hora: $(date)

            Te avisarÃ© nuevamente cuando finalicen las pruebas.

      # 1. Descargar cÃ³digo
      - name: ğŸ“¥ Checkout del repositorio
        uses: actions/checkout@v4

      # 2. Instalar JDK
      - name: â˜• Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Instalar dependencias Maven
      - name: ğŸ“¦ Instalar dependencias
        run: mvn clean install -DskipTests

      # 4. Ejecutar Karate por TAG
      - name: ğŸ§ª Ejecutar pruebas Karate con tag
        run: mvn test -Dkarate.options="--tags ${{ github.event.inputs.tag }}" -Dkarate.env=${{ github.event.inputs.ambiente }}

      # 5. Listar reportes generados
      - name: ğŸ“„ Listar reportes
        run: ls -R target

      # 6. Guardar reportes como artefacto
      - name: ğŸ“¤ Subir reportes de Karate
        uses: actions/upload-artifact@v4
        with:
          name: karate-report
          path: target/
          retention-days: 14

      # ---------- 7. NotificaciÃ³n despuÃ©s ----------
      - name: âœ‰ï¸ Enviar notificaciÃ³n DESPUÃ‰S de ejecutar pruebas
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: "GitHub Actions <${{ secrets.SMTP_USERNAME }}>"
          subject: "âœ… Pruebas Karate finalizadas â€“ Tag: ${{ github.event.inputs.tag }}"
          body: |
            Hola,

            Las pruebas Karate han finalizado.

            â€¢ Tag ejecutado: ${{ github.event.inputs.tag }}
            â€¢ Ambiente: ${{ github.event.inputs.ambiente }}
            â€¢ Estado: Completado
            â€¢ Fecha/Hora: $(date)

            Se adjunta el reporte generado.

          attachments: |
            target/karate-reports/karate-summary.html
            target/surefire-reports/*.txt
            target/karate-reports/*.html
