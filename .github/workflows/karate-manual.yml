name: üöÄ Karate API Tests - Manual

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de pruebas a ejecutar (ej: @login, @security)"
        required: true
        type: string
      ambiente:
        description: "Ambiente a ejecutar (DEV o QA)"
        required: true
        type: choice
        options:
          - DEV
          - QA
        default: QA
      correo:
        description: "Correo donde llegar√°n las notificaciones"
        required: true
        type: string

jobs:
  run-karate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:

      - name: üì• Checkout del repositorio
        uses: actions/checkout@v4

      - name: ‚òï Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ‚úâÔ∏è Notificar INICIO de ejecuci√≥n
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üîµ Inicio de ejecuci√≥n Karate ‚Äì Tag: ${{ github.event.inputs.tag }}"
          html_body: |
            <div style="font-family: Arial, sans-serif; padding: 20px; color: #333;">
              <h2 style="color: #1a73e8; margin-bottom: 10px;">üîµ Ejecuci√≥n de Pruebas Karate ‚Äì Iniciada</h2>

              <p>Hola,</p>

              <p>Se ha iniciado la ejecuci√≥n autom√°tica de pruebas <strong>Karate API</strong>.</p>

              <table style="border-collapse: collapse; margin-top: 15px;">
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Tag seleccionado:</td>
                  <td style="padding: 8px 12px;">${{ github.event.inputs.tag }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Ambiente:</td>
                  <td style="padding: 8px 12px;">${{ github.event.inputs.ambiente }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Fecha/Hora:</td>
                  <td style="padding: 8px 12px;">$(date)</td>
                </tr>
              </table>

              <p style="margin-top: 20px;">
                Recibir√°s una notificaci√≥n al finalizar la ejecuci√≥n.
              </p>

              <p style="margin-top: 25px; color: #555; font-size: 12px;">
                Sistema Autom√°tico de QA ¬∑ GitHub Actions
              </p>
            </div>


      - name: üì¶ Instalar dependencias
        run: mvn clean install -DskipTests

      - name: üß™ Ejecutar pruebas Karate con tag
        id: karate
        run: |
          echo "karate_failed=false" >> $GITHUB_OUTPUT
          mvn test -Dkarate.options="--tags ${{ github.event.inputs.tag }}" -Dkarate.env=${{ github.event.inputs.ambiente }} || echo "karate_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      # Detectar din√°micamente el JSON resumen (var√≠a por versiones)
      - name: üîç Detectar archivo de resumen Karate (busca primero)
        id: detect
        run: |
          FILE=$(find target -type f -name "karate-summary-json.txt" -o -name "karate-summary.json" | head -n 1)
          if [ -z "$FILE" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ karate-summary-json.txt ni karate-summary.json"
            echo "file_summary=" >> $GITHUB_OUTPUT
          else
            echo "Resumen encontrado en: $FILE"
            echo "file_summary=$FILE" >> $GITHUB_OUTPUT
          fi
          
      - name: üìù Generar tabla HTML de resultados (desde HTML Karate)
        id: table
        run: |
          REPORT_DIR="target/karate-reports"

          echo "<table border='1' cellspacing='0' cellpadding='6' style='border-collapse:collapse;'>" > table.html
          echo "<tr style='background:#f2f2f2; font-weight:bold;'><th>Escenario</th><th>Estado</th></tr>" >> table.html

          # Buscar todos los HTML de Karate
          for f in $(find "$REPORT_DIR" -type f -name "*.html"); do

            # Extraer nombres de escenarios
            sed -n 's/.*scenario-name">\(.*\)<\/.*/\1/p' "$f" > names.txt

            # Extraer estado usando clase scenario-time passed / failed
            sed -n 's/.*scenario-time \(passed\|failed\).*/\1/p' "$f" > status.txt

            # Combinar ambas listas
            paste names.txt status.txt | while IFS=$'\t' read -r name status; do

              # PASSED o FAILED en may√∫scula
              STATUS_UPPER=$(echo "$status" | tr '[:lower:]' '[:upper:]')

              # Color visual
              if [ "$STATUS_UPPER" = "PASSED" ]; then
                COLOR="green"
              else
                COLOR="red"
              fi

              echo "<tr>
                      <td>$name</td>
                      <td style='color:$COLOR; font-weight:bold;'>$STATUS_UPPER</td>
                    </tr>" >> table.html

            done

          done

          rm -f names.txt status.txt || true

          echo "</table>" >> table.html

          SUMMARY=$(cat table.html)
          echo "summary_table<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT



      # Crear una carpeta con SOLO los archivos del reporte (para evitar nested-zip)
      - name: üìÅ Empaquetar √∫nicamente los archivos del reporte (sin .jar/.class/etc)
        run: |
          rm -rf karate-report-package || true
          mkdir karate-report-package
          # Si existe, copiar toda la carpeta karate-reports (estilos, html, imgs)
          if [ -d "target/karate-reports" ]; then
            cp -r target/karate-reports/* karate-report-package/ || true
          else
            echo "‚ö†Ô∏è No existe target/karate-reports; nada para empaquetar"
          fi
          # opcional: eliminar archivos potencialmente bloqueados por Gmail dentro de la carpeta
          find karate-report-package -type f \( -iname "*.jar" -o -iname "*.class" -o -iname "*.sh" -o -iname "*.exe" -o -iname "*.bat" -o -iname "*.cmd" \) -delete || true
          # verifica contenido
          echo "Contenido de karate-report-package:"
          ls -R karate-report-package || true

      # SUBIR la carpeta como ARTIFACT (esto generar√° UN solo ZIP cuyo contenido son los archivos del reporte)
      - name: üì§ Subir carpeta del reporte como artefacto (genera 1 ZIP en GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: karate-report
          path: karate-report-package
          retention-days: 14

      - name: ‚úâÔ∏è Notificar FIN de ejecuci√≥n (con tabla y link al artefacto)
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üü¢ Resultados Karate ‚Äì Tag: ${{ github.event.inputs.tag }}"
          html_body: |
            <div style="font-family: Arial, sans-serif; padding: 20px; color: #333;">
              <h2 style="color: #34a853; margin-bottom: 10px;">üü¢ Resultados de Pruebas Karate</h2>

              <p>La ejecuci√≥n de pruebas <strong>ha finalizado</strong>. Aqu√≠ tienes el resumen:</p>

              <table style="border-collapse: collapse; margin-top: 15px;">
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Tag ejecutado:</td>
                  <td style="padding: 8px 12px;">${{ github.event.inputs.tag }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Ambiente:</td>
                  <td style="padding: 8px 12px;">${{ github.event.inputs.ambiente }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Estado general:</td>
                  <td style="padding: 8px 12px;">
                    <strong>
                      ${{ steps.karate.outputs.karate_failed == 'true' && '‚ùå FAILED' || '‚úÖ PASSED' }}
                    </strong>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Fecha/Hora:</td>
                  <td style="padding: 8px 12px;">$(date)</td>
                </tr>
              </table>

              <h3 style="margin-top: 30px; color:#202124;">üìä Resumen de escenarios</h3>

              <div style="margin-top: 10px;">
                ${{ steps.table.outputs.summary_table }}
              </div>

              <p style="margin-top: 20px;">
                Puedes descargar el reporte completo desde la secci√≥n de artefactos del pipeline en GitHub Actions.
              </p>

              <p style="margin-top: 25px; color: #555; font-size: 12px;">
                Sistema Autom√°tico de QA ¬∑ GitHub Actions
              </p>
            </div>
