name: üöÄ Karate API Tests - Manual

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de pruebas a ejecutar (ej: @login, @security)"
        required: true
        type: string
      ambiente:
        description: "Ambiente a ejecutar (DEV o QA)"
        required: true
        type: choice
        options:
          - DEV
          - QA
        default: QA
      correo:
        description: "Correo donde llegar√°n las notificaciones"
        required: true
        type: string

jobs:
  run-karate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:

      - name: üì• Checkout del repositorio
        uses: actions/checkout@v4

      - name: ‚òï Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ‚úâÔ∏è Notificar INICIO de ejecuci√≥n
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üîµ Inicio de ejecuci√≥n Karate ‚Äì Tag: ${{ github.event.inputs.tag }}"
          html_body: |
            <div style="font-family: Arial, sans-serif; padding: 20px; color: #333;">
              <h2 style="color: #1a73e8; margin-bottom: 10px;">üîµ Ejecuci√≥n de Pruebas Karate ‚Äì Iniciada</h2>

              <p>Hola,</p>

              <p>Se ha iniciado la ejecuci√≥n autom√°tica de pruebas <strong>Karate API</strong>.</p>

              <table style="border-collapse: collapse; margin-top: 15px;">
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Tag seleccionado:</td>
                  <td style="padding: 8px 12px;">${{ github.event.inputs.tag }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Ambiente:</td>
                  <td style="padding: 8px 12px;">${{ github.event.inputs.ambiente }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Fecha/Hora:</td>
                  <td style="padding: 8px 12px;">$(date)</td>
                </tr>
              </table>

              <p style="margin-top: 20px;">
                Recibir√°s una notificaci√≥n al finalizar la ejecuci√≥n.
              </p>

              <p style="margin-top: 25px; color: #555; font-size: 12px;">
                Sistema Autom√°tico de QA ¬∑ GitHub Actions
              </p>
            </div>


      - name: üì¶ Instalar dependencias
        run: mvn clean install -DskipTests

      - name: üß™ Ejecutar pruebas Karate con tag
        id: karate
        run: |
          echo "karate_failed=false" >> $GITHUB_OUTPUT
          mvn test -Dkarate.options="--tags ${{ github.event.inputs.tag }}" -Dkarate.env=${{ github.event.inputs.ambiente }} || echo "karate_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      # Detectar din√°micamente el JSON resumen (var√≠a por versiones)
      - name: üîç Detectar archivo de resumen Karate (busca primero)
        id: detect
        run: |
          FILE=$(find target -type f -name "karate-summary-json.txt" -o -name "karate-summary.json" | head -n 1)
          if [ -z "$FILE" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ karate-summary-json.txt ni karate-summary.json"
            echo "file_summary=" >> $GITHUB_OUTPUT
          else
            echo "Resumen encontrado en: $FILE"
            echo "file_summary=$FILE" >> $GITHUB_OUTPUT
          fi
          
      - name: üìù Generar tabla HTML de resultados (desde HTML Karate)
        id: table
        run: |
          REPORT_DIR="target/karate-reports"

          echo "<table border='1' cellspacing='0' cellpadding='6' style='border-collapse:collapse;'>" > table.html
          echo "<tr style='background:#f2f2f2; font-weight:bold;'><th>Escenario</th><th>Estado</th></tr>" >> table.html

          # Buscar todos los HTML de Karate
          for f in $(find "$REPORT_DIR" -type f -name "*.html"); do

            # Extraer nombres de escenarios
            sed -n 's/.*scenario-name">\(.*\)<\/.*/\1/p' "$f" > names.txt

            # Extraer estado usando clase scenario-time passed / failed
            sed -n 's/.*scenario-time \(passed\|failed\).*/\1/p' "$f" > status.txt

            # Combinar ambas listas
            paste names.txt status.txt | while IFS=$'\t' read -r name status; do

              # PASSED o FAILED en may√∫scula
              STATUS_UPPER=$(echo "$status" | tr '[:lower:]' '[:upper:]')

              # Color visual
              if [ "$STATUS_UPPER" = "PASSED" ]; then
                COLOR="green"
              else
                COLOR="red"
              fi

              echo "<tr>
                      <td>$name</td>
                      <td style='color:$COLOR; font-weight:bold;'>$STATUS_UPPER</td>
                    </tr>" >> table.html

            done

          done

          rm -f names.txt status.txt || true

          echo "</table>" >> table.html

          SUMMARY=$(cat table.html)
          echo "summary_table<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üìä Publicar resultados en GitHub Summary
        if: always()
        run: |
          echo "# üìä Resultados de Pruebas Karate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Informaci√≥n de Ejecuci√≥n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Par√°metro | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| üè∑Ô∏è Tag ejecutado | \`${{ github.event.inputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üåç Ambiente | \`${{ github.event.inputs.ambiente }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üìÖ Fecha/Hora | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Estado | ${{ steps.karate.outputs.karate_failed == 'true' && '‚ùå FAILED' || '‚úÖ PASSED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üß™ Resultados por Escenario" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Generar tabla en formato Markdown para GitHub
          echo "| Escenario | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          REPORT_DIR="target/karate-reports"
          for f in $(find "$REPORT_DIR" -type f -name "*.html" 2>/dev/null); do
            sed -n 's/.*scenario-name">\(.*\)<\/.*/\1/p' "$f" > names_summary.txt
            sed -n 's/.*scenario-time \(passed\|failed\).*/\1/p' "$f" > status_summary.txt
            
            paste names_summary.txt status_summary.txt | while IFS=$'\t' read -r name status; do
              STATUS_UPPER=$(echo "$status" | tr '[:lower:]' '[:upper:]')
              if [ "$STATUS_UPPER" = "PASSED" ]; then
                EMOJI="‚úÖ"
              else
                EMOJI="‚ùå"
              fi
              echo "| $name | $EMOJI $STATUS_UPPER |" >> $GITHUB_STEP_SUMMARY
            done
          done
          
          rm -f names_summary.txt status_summary.txt || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîó Enlaces √ötiles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üìÑ [Ver reporte completo en GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/karate-summary.html)" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ [Descargar artefactos](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY



      # Crear una carpeta con SOLO los archivos del reporte (para evitar nested-zip)
      - name: üìÅ Empaquetar √∫nicamente los archivos del reporte (sin .jar/.class/etc)
        run: |
          rm -rf karate-report-package || true
          mkdir karate-report-package
          # Si existe, copiar toda la carpeta karate-reports (estilos, html, imgs)
          if [ -d "target/karate-reports" ]; then
            cp -r target/karate-reports/* karate-report-package/ || true
          else
            echo "‚ö†Ô∏è No existe target/karate-reports; nada para empaquetar"
          fi
          # opcional: eliminar archivos potencialmente bloqueados por Gmail dentro de la carpeta
          find karate-report-package -type f \( -iname "*.jar" -o -iname "*.class" -o -iname "*.sh" -o -iname "*.exe" -o -iname "*.bat" -o -iname "*.cmd" \) -delete || true
          # verifica contenido
          echo "Contenido de karate-report-package:"
          ls -R karate-report-package || true

      # SUBIR la carpeta como ARTIFACT (esto generar√° UN solo ZIP cuyo contenido son los archivos del reporte)
      - name: üì§ Subir carpeta del reporte como artefacto (genera 1 ZIP en GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: karate-report
          path: karate-report-package
          retention-days: 14

      - name: üåê Publicar reporte en GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./karate-report-package
          destination_dir: reports/${{ github.run_number }}
          keep_files: true

      - name: üìù Crear √≠ndice de reportes
        if: always()
        run: |
          mkdir -p gh-pages-temp
          cat > gh-pages-temp/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Reportes Karate - Historial</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
              h1 { color: #1a73e8; }
              .report-list { list-style: none; padding: 0; }
              .report-item { 
                background: white; 
                padding: 15px; 
                margin: 10px 0; 
                border-radius: 5px; 
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              .report-link { 
                color: #1a73e8; 
                text-decoration: none; 
                font-size: 18px; 
                font-weight: bold;
              }
              .report-link:hover { text-decoration: underline; }
              .report-date { color: #666; font-size: 14px; margin-top: 5px; }
            </style>
          </head>
          <body>
            <h1>üìä Historial de Reportes Karate</h1>
            <p>√öltimo reporte generado: <strong>Run #${{ github.run_number }}</strong></p>
            <ul class="report-list">
              <li class="report-item">
                <a class="report-link" href="reports/${{ github.run_number }}/karate-summary.html">
                  üìÑ Reporte #${{ github.run_number }} - Tag: ${{ github.event.inputs.tag }}
                </a>
                <div class="report-date">Ambiente: ${{ github.event.inputs.ambiente }} | Fecha: $(date '+%Y-%m-%d %H:%M:%S')</div>
              </li>
            </ul>
          </body>
          </html>
          EOF

      - name: üåê Publicar √≠ndice en GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-temp
          keep_files: true

        

      - name: ‚úâÔ∏è Notificar FIN de ejecuci√≥n (con tabla y link al artefacto)
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üü¢ Resultados Karate ‚Äì Tag: ${{ github.event.inputs.tag }}"
          html_body: |
            <div style="font-family: Arial, sans-serif; padding: 20px; color: #333;">
              <h2 style="color: #34a853; margin-bottom: 10px;">üü¢ Resultados de Pruebas Karate</h2>

              <p>La ejecuci√≥n de pruebas <strong>ha finalizado</strong>. Aqu√≠ tienes el resumen:</p>

              <table style="border-collapse: collapse; margin-top: 15px;">
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Tag ejecutado:</td>
                  <td style="padding: 8px 12px;">${{ github.event.inputs.tag }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Ambiente:</td>
                  <td style="padding: 8px 12px;">${{ github.event.inputs.ambiente }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Estado general:</td>
                  <td style="padding: 8px 12px;">
                    <strong>
                      ${{ steps.karate.outputs.karate_failed == 'true' && '‚ùå FAILED' || '‚úÖ PASSED' }}
                    </strong>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 8px 12px; background: #f5f5f5; font-weight: bold;">Fecha/Hora:</td>
                  <td style="padding: 8px 12px;">$(date)</td>
                </tr>
              </table>

              <h3 style="margin-top: 30px; color:#202124;">üìä Resumen de escenarios</h3>

              <div style="margin-top: 10px;">
                ${{ steps.table.outputs.summary_table }}
              </div>

              <p style="margin-top: 20px;">
                üåê <strong>Ver reporte en l√≠nea:</strong> 
                <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/karate-summary.html">
                  Click aqu√≠ para ver el reporte completo
                </a>
              </p>

              <p>
                Tambi√©n puedes descargar el reporte desde la secci√≥n de artefactos del pipeline en GitHub Actions.
              </p>

              <p style="margin-top: 25px; color: #555; font-size: 12px;">
                Sistema Autom√°tico de QA ¬∑ GitHub Actions
              </p>
            </div>
