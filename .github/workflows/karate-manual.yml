name: üöÄ Karate API Tests - Manual & Scheduled

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de pruebas a ejecutar (ej: @login, @security)"
        required: true
        type: string
      ambiente:
        description: "Ambiente a ejecutar (DEV o QA)"
        required: true
        type: choice
        options:
          - DEV
          - QA
        default: QA
      correo:
        description: "Correo donde llegar√°n las notificaciones"
        required: true
        type: string
  
  schedule:
    # Lunes a Viernes a las 8 AM (Per√∫ UTC-5 = 13:00 UTC)
    - cron: '0 13 * * 1-5'
    # S√°bados y Domingos a las 10 AM (Per√∫ UTC-5 = 15:00 UTC)
    - cron: '0 15 * * 0,6'

jobs:
  run-karate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:

      - name: üéØ Determinar tag y par√°metros seg√∫n trigger
        id: setup
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # Detectar qu√© cron se ejecut√≥ basado en la hora UTC
            HOUR=$(date -u +%H)
            DAY=$(date -u +%u)  # 1=Lunes, 7=Domingo
            
            if [ "$HOUR" = "13" ] && [ "$DAY" -ge 1 ] && [ "$DAY" -le 5 ]; then
              # Lunes a Viernes a las 13:00 UTC (8 AM Per√∫)
              echo "tag=@dailyTests" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "15" ] && ([ "$DAY" = "6" ] || [ "$DAY" = "7" ]); then
              # S√°bado o Domingo a las 15:00 UTC (10 AM Per√∫)
              echo "tag=@postLoginRolAuxiliar" >> $GITHUB_OUTPUT
            else
              echo "tag=@dailyTests" >> $GITHUB_OUTPUT
            fi
            echo "ambiente=QA" >> $GITHUB_OUTPUT
            echo "correo=2101010261@undc.edu.pe" >> $GITHUB_OUTPUT
          else
            # Ejecuci√≥n manual
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
            echo "ambiente=${{ github.event.inputs.ambiente }}" >> $GITHUB_OUTPUT
            echo "correo=${{ github.event.inputs.correo }}" >> $GITHUB_OUTPUT
          fi

      - name: üì• Checkout del repositorio
        uses: actions/checkout@v4

      - name: ‚òï Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: üïê Capturar fecha de inicio
        id: fecha_inicio
        run: |
          echo "datetime=$(TZ=America/Lima date '+%d/%m/%Y %H:%M:%S %Z')" >> $GITHUB_OUTPUT
          echo "year=$(TZ=America/Lima date '+%Y')" >> $GITHUB_OUTPUT

      - name: ‚úâÔ∏è Notificar INICIO de ejecuci√≥n
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ steps.setup.outputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üîµ Inicio de Pruebas Karate ‚Äì ${{ steps.setup.outputs.tag }}"
          html_body: |
            <!DOCTYPE html>
            <html lang="es">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
            </head>
            <body style="margin: 0; padding: 0; background-color: #f5f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
              <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f5f7fa;">
                <tr>
                  <td align="center" style="padding: 40px 20px;">
                    <table width="600" cellpadding="0" cellspacing="0" border="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
                      
                      <!-- Header con logo -->
                      <tr>
                        <td style="background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%); padding: 30px; text-align: center;">
                          <img src="https://res.cloudinary.com/dvrsdqsl1/image/upload/v1764399269/Blue_Minimalist_Technology_Cube_Logo_1_x445ab.png" alt="Logo" style="max-width: 120px; height: auto; margin-bottom: 15px;">
                          <h1 style="color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;">üîµ Ejecuci√≥n de Pruebas Iniciada</h1>
                        </td>
                      </tr>
                      
                      <!-- Contenido -->
                      <tr>
                        <td style="padding: 40px 30px;">
                          <p style="color: #333333; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
                            Estimado/a,
                          </p>
                          <p style="color: #555555; font-size: 15px; line-height: 1.6; margin: 0 0 30px 0;">
                            Se ha iniciado la ejecuci√≥n autom√°tica de pruebas <strong style="color: #1a73e8;">Karate API</strong> en el sistema de testing continuo.
                          </p>
                          
                          <!-- Informaci√≥n de ejecuci√≥n -->
                          <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f8f9fa; border-radius: 8px; overflow: hidden; margin-bottom: 30px;">
                            <tr>
                              <td style="padding: 20px;">
                                <table width="100%" cellpadding="8" cellspacing="0" border="0">
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; width: 35%;">üè∑Ô∏è Tag seleccionado:</td>
                                    <td style="color: #1a73e8; font-size: 14px; font-weight: 600;">${{ steps.setup.outputs.tag }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üåç Ambiente:</td>
                                    <td style="color: #1a73e8; font-size: 14px; font-weight: 600; padding-top: 10px;">${{ steps.setup.outputs.ambiente }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üìÖ Fecha/Hora:</td>
                                    <td style="color: #333333; font-size: 14px; padding-top: 10px;">${{ steps.fecha_inicio.outputs.datetime }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üî¢ Ejecuci√≥n #:</td>
                                    <td style="color: #333333; font-size: 14px; padding-top: 10px;">${{ github.run_number }}</td>
                                  </tr>
                                </table>
                              </td>
                            </tr>
                          </table>
                          
                          <!-- Nota informativa -->
                          <div style="background-color: #e3f2fd; border-left: 4px solid #1a73e8; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <p style="color: #1565c0; font-size: 14px; margin: 0; line-height: 1.5;">
                              <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Recibir√°s una notificaci√≥n autom√°tica con los resultados cuando la ejecuci√≥n finalice.
                            </p>
                          </div>
                          
                          <p style="color: #555555; font-size: 14px; line-height: 1.6; margin: 20px 0 0 0;">
                            Saludos cordiales,<br>
                            <strong style="color: #1a73e8;">Sistema Autom√°tico de QA</strong>
                          </p>
                        </td>
                      </tr>
                      
                      <!-- Footer -->
                      <tr>
                        <td style="background-color: #f8f9fa; padding: 20px 30px; border-top: 1px solid #e0e0e0;">
                          <p style="color: #999999; font-size: 12px; margin: 0; text-align: center;">
                            GitHub Actions ¬∑ Testing Continuo ¬∑ ${{ steps.fecha_inicio.outputs.year }}
                          </p>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </body>
            </html>


      - name: üì¶ Instalar dependencias
        run: mvn clean install -DskipTests

      - name: üß™ Ejecutar pruebas Karate con tag
        id: karate
        run: |
          echo "karate_failed=false" >> $GITHUB_OUTPUT
          mvn test -Dkarate.options="--tags ${{ steps.setup.outputs.tag }}" -Dkarate.env=${{ steps.setup.outputs.ambiente }} || echo "karate_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      # Detectar din√°micamente el JSON resumen (var√≠a por versiones)
      - name: üîç Detectar archivo de resumen Karate (busca primero)
        id: detect
        run: |
          FILE=$(find target -type f -name "karate-summary-json.txt" -o -name "karate-summary.json" | head -n 1)
          if [ -z "$FILE" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ karate-summary-json.txt ni karate-summary.json"
            echo "file_summary=" >> $GITHUB_OUTPUT
          else
            echo "Resumen encontrado en: $FILE"
            echo "file_summary=$FILE" >> $GITHUB_OUTPUT
          fi
          
      - name: üìù Generar tabla HTML de resultados (desde HTML Karate)
        id: table
        run: |
          REPORT_DIR="target/karate-reports"

          echo "<table border='1' cellspacing='0' cellpadding='6' style='border-collapse:collapse;'>" > table.html
          echo "<tr style='background:#f2f2f2; font-weight:bold;'><th>Escenario</th><th>Estado</th></tr>" >> table.html

          # Buscar todos los HTML de Karate
          for f in $(find "$REPORT_DIR" -type f -name "*.html"); do

            # Extraer nombres de escenarios
            sed -n 's/.*scenario-name">\(.*\)<\/.*/\1/p' "$f" > names.txt

            # Extraer estado usando clase scenario-time passed / failed
            sed -n 's/.*scenario-time \(passed\|failed\).*/\1/p' "$f" > status.txt

            # Combinar ambas listas
            paste names.txt status.txt | while IFS=$'\t' read -r name status; do

              # PASSED o FAILED en may√∫scula
              STATUS_UPPER=$(echo "$status" | tr '[:lower:]' '[:upper:]')

              # Color visual
              if [ "$STATUS_UPPER" = "PASSED" ]; then
                COLOR="green"
              else
                COLOR="red"
              fi

              echo "<tr>
                      <td>$name</td>
                      <td style='color:$COLOR; font-weight:bold;'>$STATUS_UPPER</td>
                    </tr>" >> table.html

            done

          done

          rm -f names.txt status.txt || true

          echo "</table>" >> table.html

          SUMMARY=$(cat table.html)
          echo "summary_table<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üìä Publicar resultados en GitHub Summary
        if: always()
        run: |
          echo "# üìä Resultados de Pruebas Karate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Informaci√≥n de Ejecuci√≥n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Par√°metro | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| üè∑Ô∏è Tag ejecutado | \`${{ steps.setup.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üåç Ambiente | \`${{ steps.setup.outputs.ambiente }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üìÖ Fecha/Hora | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Estado | ${{ steps.karate.outputs.karate_failed == 'true' && '‚ùå FAILED' || '‚úÖ PASSED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üß™ Resultados por Escenario" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Generar tabla en formato Markdown para GitHub
          echo "| Escenario | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          REPORT_DIR="target/karate-reports"
          for f in $(find "$REPORT_DIR" -type f -name "*.html" 2>/dev/null); do
            sed -n 's/.*scenario-name">\(.*\)<\/.*/\1/p' "$f" > names_summary.txt
            sed -n 's/.*scenario-time \(passed\|failed\).*/\1/p' "$f" > status_summary.txt
            
            paste names_summary.txt status_summary.txt | while IFS=$'\t' read -r name status; do
              STATUS_UPPER=$(echo "$status" | tr '[:lower:]' '[:upper:]')
              if [ "$STATUS_UPPER" = "PASSED" ]; then
                EMOJI="‚úÖ"
              else
                EMOJI="‚ùå"
              fi
              echo "| $name | $EMOJI $STATUS_UPPER |" >> $GITHUB_STEP_SUMMARY
            done
          done
          
          rm -f names_summary.txt status_summary.txt || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîó Enlaces √ötiles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üìÑ [Ver reporte completo en GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/karate-summary.html)" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ [Descargar artefactos](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY



      # Crear una carpeta con SOLO los archivos del reporte (para evitar nested-zip)
      - name: üìÅ Empaquetar √∫nicamente los archivos del reporte (sin .jar/.class/etc)
        run: |
          rm -rf karate-report-package || true
          mkdir karate-report-package
          # Si existe, copiar toda la carpeta karate-reports (estilos, html, imgs)
          if [ -d "target/karate-reports" ]; then
            cp -r target/karate-reports/* karate-report-package/ || true
          else
            echo "‚ö†Ô∏è No existe target/karate-reports; nada para empaquetar"
          fi
          # opcional: eliminar archivos potencialmente bloqueados por Gmail dentro de la carpeta
          find karate-report-package -type f \( -iname "*.jar" -o -iname "*.class" -o -iname "*.sh" -o -iname "*.exe" -o -iname "*.bat" -o -iname "*.cmd" \) -delete || true
          # verifica contenido
          echo "Contenido de karate-report-package:"
          ls -R karate-report-package || true

      # SUBIR la carpeta como ARTIFACT (esto generar√° UN solo ZIP cuyo contenido son los archivos del reporte)
      - name: üì§ Subir carpeta del reporte como artefacto (genera 1 ZIP en GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: karate-report
          path: karate-report-package
          retention-days: 14

      - name: üìã Crear metadata del reporte
        if: always()
        run: |
          # Configurar zona horaria de Per√∫
          export TZ=America/Lima
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Crear archivo de metadata JSON
          cat > karate-report-package/metadata.json << EOF
          {
            "run_number": "${{ github.run_number }}",
            "tag": "${{ steps.setup.outputs.tag }}",
            "ambiente": "${{ steps.setup.outputs.ambiente }}",
            "fecha": "${CURRENT_DATE}",
            "timezone": "America/Lima"
          }
          EOF
          
          echo "Metadata creado para reporte #${{ github.run_number }}"
          cat karate-report-package/metadata.json

      - name: üåê Publicar reporte en GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./karate-report-package
          destination_dir: reports/${{ github.run_number }}
          keep_files: true

      - name: üìù Crear √≠ndice de reportes con historial completo
        if: always()
        run: |
          # Configurar zona horaria de Per√∫
          export TZ=America/Lima
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Checkout de la rama gh-pages para leer reportes existentes
          git fetch origin gh-pages:gh-pages || true
          git checkout gh-pages || true
          
          # Obtener lista de reportes existentes
          REPORTS_DIRS=$(find reports -mindepth 1 -maxdepth 1 -type d 2>/dev/null | sort -rn || echo "")
          
          # Volver a la rama de trabajo
          git checkout -
          
          # Crear carpeta temporal
          mkdir -p gh-pages-temp
          
          # Generar fecha actual
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Crear HTML con historial completo
          cat > gh-pages-temp/index.html << EOF
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Reportes Karate - Historial</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
              }
              .container { 
                max-width: 1200px; 
                margin: 0 auto; 
                animation: fadeIn 0.6s ease-in;
              }
              @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
              }
              h1 { 
                color: #ffffff; 
                font-size: 2.5rem; 
                margin-bottom: 30px; 
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                text-align: center;
              }
              h2 { 
                color: #2d3748; 
                font-size: 1.5rem; 
                margin-bottom: 20px;
              }
              .stats, .executor-panel { 
                background: rgba(255, 255, 255, 0.95); 
                backdrop-filter: blur(10px);
                padding: 30px; 
                border-radius: 15px; 
                margin-bottom: 25px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
              }
              .stats:hover, .executor-panel:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 40px rgba(0,0,0,0.3);
              }
              .executor-panel { 
                background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                border-left: 5px solid #34a853;
              }
              .form-group { margin-bottom: 20px; }
              .form-group label { 
                display: block; 
                margin-bottom: 8px; 
                font-weight: 600; 
                color: #2d3748;
                font-size: 0.95rem;
              }
              .form-group input, .form-group select { 
                width: 100%; 
                padding: 12px 15px; 
                border: 2px solid #e2e8f0; 
                border-radius: 8px; 
                font-size: 14px;
                transition: all 0.3s ease;
                background: white;
              }
              .form-group input:focus, .form-group select:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                transform: translateY(-2px);
              }
              .btn-execute { 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white; 
                padding: 15px 30px; 
                border: none; 
                border-radius: 8px; 
                cursor: pointer; 
                font-size: 16px;
                font-weight: 700;
                width: 100%;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
              }
              .btn-execute:hover { 
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
              }
              .btn-execute:active { transform: translateY(0); }
              .btn-execute:disabled { 
                background: #cbd5e0; 
                cursor: not-allowed;
                box-shadow: none;
              }
              .message { 
                padding: 15px 20px; 
                border-radius: 8px; 
                margin-top: 20px; 
                display: none;
                font-weight: 500;
                animation: slideIn 0.3s ease;
              }
              @keyframes slideIn {
                from { opacity: 0; transform: translateX(-20px); }
                to { opacity: 1; transform: translateX(0); }
              }
              .message.success { 
                background: #d4edda; 
                color: #155724; 
                border-left: 4px solid #28a745;
              }
              .message.error { 
                background: #f8d7da; 
                color: #721c24; 
                border-left: 4px solid #dc3545;
              }
              .message.show { display: block; }
              .report-list { list-style: none; padding: 0; }
              .report-item { 
                background: rgba(255, 255, 255, 0.95); 
                padding: 20px; 
                margin: 15px 0; 
                border-radius: 12px; 
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
                border-left: 4px solid #667eea;
              }
              .report-item:hover {
                transform: translateX(10px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.15);
              }
              .report-link { 
                color: #667eea; 
                text-decoration: none; 
                font-size: 1.1rem; 
                font-weight: 700;
                transition: color 0.3s ease;
              }
              .report-link:hover { 
                color: #764ba2;
                text-decoration: underline;
              }
              .report-date { 
                color: #718096; 
                font-size: 0.9rem; 
                margin-top: 8px;
                font-weight: 500;
              }
              .badge { 
                display: inline-block; 
                padding: 4px 12px; 
                border-radius: 20px; 
                font-size: 0.75rem; 
                margin-left: 10px;
                font-weight: 700;
                text-transform: uppercase;
              }
              .badge-new { 
                background: linear-gradient(135deg, #34a853 0%, #2d9e47 100%);
                color: white;
                box-shadow: 0 2px 8px rgba(52, 168, 83, 0.4);
              }
              .info-text { 
                color: #718096; 
                font-size: 0.8rem; 
                margin-top: 8px;
                font-weight: 500;
              }
              .info-text a { color: #667eea; font-weight: 600; }
              
              /* Chatbot Styles */
              #chatbot-container {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
              }
              #chatbot-button {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: none;
                cursor: pointer;
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 28px;
                transition: all 0.3s ease;
                animation: pulse 2s infinite;
              }
              @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
              }
              #chatbot-button:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 25px rgba(102, 126, 234, 0.8);
              }
              #chatbot-window {
                display: none;
                position: fixed;
                bottom: 90px;
                right: 20px;
                width: 350px;
                height: 500px;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                flex-direction: column;
                overflow: hidden;
                animation: slideUp 0.3s ease;
              }
              @keyframes slideUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
              }
              #chatbot-window.active { display: flex; }
              #chatbot-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 20px;
                font-weight: 700;
                display: flex;
                justify-content: space-between;
                align-items: center;
              }
              #chatbot-close {
                background: none;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background 0.3s ease;
              }
              #chatbot-close:hover { background: rgba(255,255,255,0.2); }
              #chatbot-messages {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                background: #f7fafc;
              }
              .chat-message {
                margin-bottom: 15px;
                animation: fadeIn 0.3s ease;
              }
              .chat-message.bot { text-align: left; }
              .chat-message.user { text-align: right; }
              .chat-bubble {
                display: inline-block;
                padding: 10px 15px;
                border-radius: 15px;
                max-width: 80%;
                word-wrap: break-word;
              }
              .chat-bubble.bot {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-bottom-left-radius: 5px;
              }
              .chat-bubble.user {
                background: #e2e8f0;
                color: #2d3748;
                border-bottom-right-radius: 5px;
              }
              #chatbot-input-container {
                padding: 15px;
                background: white;
                border-top: 1px solid #e2e8f0;
                display: flex;
                gap: 10px;
              }
              #chatbot-input {
                flex: 1;
                padding: 10px 15px;
                border: 2px solid #e2e8f0;
                border-radius: 20px;
                font-size: 14px;
                outline: none;
              }
              #chatbot-input:focus { border-color: #667eea; }
              #chatbot-send {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.2s ease;
              }
              #chatbot-send:hover { transform: scale(1.1); }
              .quick-questions {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-top: 10px;
              }
              .quick-question-btn {
                background: white;
                border: 2px solid #667eea;
                color: #667eea;
                padding: 8px 12px;
                border-radius: 20px;
                cursor: pointer;
                font-size: 12px;
                text-align: left;
                transition: all 0.3s ease;
                font-weight: 600;
              }
              .quick-question-btn:hover {
                background: #667eea;
                color: white;
                transform: translateX(5px);
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üìä Historial de Reportes Karate</h1>
              
              <!-- Panel de ejecuci√≥n -->
              <div class="executor-panel">
                <h2>üöÄ Ejecutar Nuevas Pruebas</h2>
                <form id="executionForm">
                  <div class="form-group">
                    <label for="githubToken">GitHub Token (PAT)</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" required>
                    <p class="info-text">Necesitas un Personal Access Token con permiso 'workflow'. <a href="https://github.com/settings/tokens/new?scopes=workflow" target="_blank">Crear token</a></p>
                  </div>
                  
                  <div class="form-group">
                    <label for="tag">Tag a ejecutar</label>
                    <input type="text" id="tag" placeholder="@postLoginRolDirectivo" required>
                    <p class="info-text">Ejemplo: @postLoginRolDirectivo, @security, @smoke</p>
                  </div>
                  
                  <div class="form-group">
                    <label for="ambiente">Ambiente</label>
                    <select id="ambiente" required>
                      <option value="QA" selected>QA</option>
                      <option value="DEV">DEV</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="correo">Correo de notificaci√≥n</label>
                    <input type="email" id="correo" placeholder="tu-correo@ejemplo.com" value="2101010261@undc.edu.pe" required>
                  </div>
                  
                  <button type="submit" class="btn-execute" id="btnExecute">
                    ‚ñ∂Ô∏è Ejecutar Pruebas
                  </button>
                  
                  <div id="message" class="message"></div>
                </form>
              </div>
              
              <div class="stats">
                <p><strong>√öltimo reporte generado:</strong> Run #${{ github.run_number }}</p>
                <p><strong>Tag:</strong> ${{ steps.setup.outputs.tag }}</p>
                <p><strong>Ambiente:</strong> ${{ steps.setup.outputs.ambiente }}</p>
                <p><strong>Fecha:</strong> ${CURRENT_DATE}</p>
              </div>
              
              <h2>üìã Historial de Ejecuciones</h2>
              <ul class="report-list">
          EOF
          
          # Agregar reporte actual primero
          cat >> gh-pages-temp/index.html << EOF
                <li class="report-item">
                  <a class="report-link" href="reports/${{ github.run_number }}/karate-summary.html">
                    üìÑ Reporte #${{ github.run_number }} - Tag: ${{ steps.setup.outputs.tag }}
                  </a>
                  <span class="badge badge-new">NUEVO</span>
                  <div class="report-date">Ambiente: ${{ steps.setup.outputs.ambiente }} | Fecha: ${CURRENT_DATE}</div>
                </li>
          EOF
          
          # Agregar reportes anteriores
          if [ -n "$REPORTS_DIRS" ]; then
            for report_dir in $REPORTS_DIRS; do
              RUN_NUM=$(basename "$report_dir")
              # Evitar duplicar el reporte actual
              if [ "$RUN_NUM" != "${{ github.run_number }}" ]; then
                # Intentar leer metadata del reporte
                METADATA_FILE="$report_dir/metadata.json"
                if [ -f "$METADATA_FILE" ]; then
                  # Extraer informaci√≥n del metadata
                  TAG=$(grep -oP '"tag":\s*"\K[^"]+' "$METADATA_FILE" 2>/dev/null || echo "N/A")
                  AMBIENTE=$(grep -oP '"ambiente":\s*"\K[^"]+' "$METADATA_FILE" 2>/dev/null || echo "N/A")
                  FECHA=$(grep -oP '"fecha":\s*"\K[^"]+' "$METADATA_FILE" 2>/dev/null || echo "N/A")
                  
                  cat >> gh-pages-temp/index.html << EOF
              <li class="report-item">
                <a class="report-link" href="$report_dir/karate-summary.html">
                  üìÑ Reporte #$RUN_NUM - Tag: $TAG
                </a>
                <div class="report-date">Ambiente: $AMBIENTE | Fecha: $FECHA</div>
              </li>
          EOF
                else
                  # Si no existe metadata, obtener fecha del commit de Git
                  COMMIT_DATE=$(git log --all --format="%cd" --date=format:'%Y-%m-%d %H:%M:%S' --diff-filter=A -- "$report_dir" 2>/dev/null | head -n1)
                  
                  if [ -z "$COMMIT_DATE" ]; then
                    # Si no se encuentra en git log, intentar con la fecha del √∫ltimo commit que modific√≥ el directorio
                    COMMIT_DATE=$(git log -1 --format="%cd" --date=format:'%Y-%m-%d %H:%M:%S' -- "$report_dir" 2>/dev/null)
                  fi
                  
                  if [ -z "$COMMIT_DATE" ]; then
                    COMMIT_DATE="Fecha no disponible"
                  fi
                  
                  cat >> gh-pages-temp/index.html << EOF
              <li class="report-item">
                <a class="report-link" href="$report_dir/karate-summary.html">
                  üìÑ Reporte #$RUN_NUM
                </a>
                <div class="report-date">Reporte hist√≥rico | Fecha: $COMMIT_DATE</div>
              </li>
          EOF
                fi
              fi
            done
          fi
          
          # Cerrar HTML con JavaScript mejorado
          cat >> gh-pages-temp/index.html << 'EOF'
              </ul>
            </div>
            
            <!-- Modal de confirmaci√≥n -->
            <div id="confirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
              <div style="background:white; padding:30px; border-radius:8px; max-width:500px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                <h3 style="color:#1a73e8; margin-top:0;">üöÄ Confirmar Ejecuci√≥n</h3>
                <p style="font-size:16px; color:#333; line-height:1.6;">
                  Las pruebas se ejecutar√°n en segundo plano y recibir√°s una notificaci√≥n en tu correo <strong id="modalEmail"></strong> cuando finalicen.
                </p>
                <p style="font-size:14px; color:#666; margin-top:10px;">
                  Tag: <strong id="modalTag"></strong> | Ambiente: <strong id="modalAmbiente"></strong>
                </p>
                <div style="margin-top:25px; display:flex; gap:10px; justify-content:center;">
                  <button onclick="cancelExecution()" style="background:#666; color:white; padding:10px 20px; border:none; border-radius:4px; cursor:pointer; font-size:14px;">
                    Cancelar
                  </button>
                  <button onclick="confirmExecution()" style="background:#1a73e8; color:white; padding:10px 20px; border:none; border-radius:4px; cursor:pointer; font-size:14px; font-weight:bold;">
                    ‚úì Confirmar y Ejecutar
                  </button>
                </div>
              </div>
            </div>
            
            <script>
              const form = document.getElementById('executionForm');
              const btnExecute = document.getElementById('btnExecute');
              const message = document.getElementById('message');
              const confirmModal = document.getElementById('confirmModal');
              let formData = {};
              
              // Validaci√≥n de campos
              function validateForm() {
                const token = document.getElementById('githubToken').value.trim();
                const tag = document.getElementById('tag').value.trim();
                const correo = document.getElementById('correo').value.trim();
                
                // Validar token
                if (!token) {
                  showError('‚ö†Ô∏è Por favor ingresa tu GitHub Token');
                  return false;
                }
                
                if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                  showError('‚ö†Ô∏è El token debe comenzar con "ghp_" o "github_pat_"');
                  return false;
                }
                
                if (token.length < 40) {
                  showError('‚ö†Ô∏è El token parece ser demasiado corto. Verifica que sea correcto.');
                  return false;
                }
                
                // Validar tag
                if (!tag) {
                  showError('‚ö†Ô∏è Por favor ingresa un tag para ejecutar');
                  return false;
                }
                
                if (!tag.startsWith('@')) {
                  showError('‚ö†Ô∏è El tag debe comenzar con @ (ejemplo: @postLoginRolDirectivo)');
                  return false;
                }
                
                // Validar correo
                if (!correo) {
                  showError('‚ö†Ô∏è Por favor ingresa un correo electr√≥nico');
                  return false;
                }
                
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(correo)) {
                  showError('‚ö†Ô∏è Por favor ingresa un correo electr√≥nico v√°lido');
                  return false;
                }
                
                return true;
              }
              
              function showError(msg) {
                message.className = 'message error show';
                message.textContent = msg;
                setTimeout(() => {
                  message.className = 'message';
                }, 5000);
              }
              
              function showConfirmModal() {
                document.getElementById('modalEmail').textContent = formData.correo;
                document.getElementById('modalTag').textContent = formData.tag;
                document.getElementById('modalAmbiente').textContent = formData.ambiente;
                confirmModal.style.display = 'flex';
              }
              
              function cancelExecution() {
                confirmModal.style.display = 'none';
                formData = {};
              }
              
              async function confirmExecution() {
                confirmModal.style.display = 'none';
                
                // Deshabilitar bot√≥n y mostrar loading
                btnExecute.disabled = true;
                btnExecute.textContent = '‚è≥ Ejecutando...';
                message.className = 'message';
                message.style.display = 'none';
                
                try {
                  const response = await fetch('https://api.github.com/repos/${{ github.repository }}/actions/workflows/karate-manual.yml/dispatches', {
                    method: 'POST',
                    headers: {
                      'Accept': 'application/vnd.github.v3+json',
                      'Authorization': 'token ' + formData.token,
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      ref: 'main',
                      inputs: {
                        tag: formData.tag,
                        ambiente: formData.ambiente,
                        correo: formData.correo
                      }
                    })
                  });
                  
                  if (response.status === 204) {
                    message.className = 'message success show';
                    message.textContent = '‚úÖ Pruebas iniciadas correctamente. Recibir√°s una notificaci√≥n por correo cuando finalicen.';
                    form.reset();
                    document.getElementById('correo').value = '2101010261@undc.edu.pe';
                    
                    // Recargar p√°gina despu√©s de 3 segundos
                    setTimeout(() => {
                      window.location.reload();
                    }, 3000);
                  } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error desconocido');
                  }
                } catch (error) {
                  message.className = 'message error show';
                  message.textContent = '‚ùå Error al ejecutar las pruebas: ' + error.message + '. Verifica tu token y permisos.';
                } finally {
                  btnExecute.disabled = false;
                  btnExecute.textContent = '‚ñ∂Ô∏è Ejecutar Pruebas';
                  formData = {};
                }
              }
              
              form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Validar formulario
                if (!validateForm()) {
                  return;
                }
                
                // Guardar datos del formulario
                formData = {
                  token: document.getElementById('githubToken').value.trim(),
                  tag: document.getElementById('tag').value.trim(),
                  ambiente: document.getElementById('ambiente').value,
                  correo: document.getElementById('correo').value.trim()
                };
                
                // Mostrar modal de confirmaci√≥n
                showConfirmModal();
              });
            </script>
            
            <!-- Chatbot Assistant -->
            <div id="chatbot-container">
              <button id="chatbot-button" aria-label="Abrir asistente">üí¨</button>
              <div id="chatbot-window">
                <div id="chatbot-header">
                  <span>ü§ñ Asistente QA</span>
                  <button id="chatbot-close" aria-label="Cerrar">√ó</button>
                </div>
                <div id="chatbot-messages">
                  <div class="chat-message bot">
                    <div class="chat-bubble bot">
                      ¬°Hola! üëã Soy tu asistente QA. ¬øEn qu√© puedo ayudarte hoy?
                    </div>
                  </div>
                  <div class="quick-questions">
                    <button class="quick-question-btn" data-question="¬øC√≥mo ejecuto pruebas?">‚ùì ¬øC√≥mo ejecuto pruebas?</button>
                    <button class="quick-question-btn" data-question="¬øQu√© es un token PAT?">üîë ¬øQu√© es un token PAT?</button>
                    <button class="quick-question-btn" data-question="¬øQu√© tags puedo usar?">üè∑Ô∏è ¬øQu√© tags puedo usar?</button>
                    <button class="quick-question-btn" data-question="¬øC√≥mo veo los reportes?">üìä ¬øC√≥mo veo los reportes?</button>
                  </div>
                </div>
                <div id="chatbot-input-container">
                  <input type="text" id="chatbot-input" placeholder="Escribe tu pregunta...">
                  <button id="chatbot-send" aria-label="Enviar">‚û§</button>
                </div>
              </div>
            </div>
            
            <script>
              // Chatbot functionality
              const chatbotButton = document.getElementById('chatbot-button');
              const chatbotWindow = document.getElementById('chatbot-window');
              const chatbotClose = document.getElementById('chatbot-close');
              const chatbotMessages = document.getElementById('chatbot-messages');
              const chatbotInput = document.getElementById('chatbot-input');
              const chatbotSend = document.getElementById('chatbot-send');
              const quickQuestionBtns = document.querySelectorAll('.quick-question-btn');
              
              const responses = {
                '¬øc√≥mo ejecuto pruebas?': '‚úÖ Para ejecutar pruebas:\n1. Necesitas un GitHub Token (PAT) con permisos de workflow\n2. Ingresa el tag que deseas ejecutar (ej: @postLoginRolDirectivo)\n3. Selecciona el ambiente (QA o DEV)\n4. Ingresa tu correo para recibir notificaciones\n5. Haz clic en "Ejecutar Pruebas"',
                '¬øqu√© es un token pat?': 'üîë Un Personal Access Token (PAT) es una credencial de GitHub que permite ejecutar acciones autom√°ticas. Para crear uno:\n1. Ve a GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens\n2. Genera un nuevo token con el permiso "workflow"\n3. Copia el token y √∫salo en el formulario\n‚ö†Ô∏è Gu√°rdalo en un lugar seguro, no se mostrar√° nuevamente',
                '¬øqu√© tags puedo usar?': 'üè∑Ô∏è Algunos tags disponibles:\n‚Ä¢ @postLoginRolDirectivo - Login rol directivo\n‚Ä¢ @postLoginRolAuxiliar - Login rol auxiliar\n‚Ä¢ @security - Pruebas de seguridad\n‚Ä¢ @smoke - Pruebas r√°pidas\n‚Ä¢ @contract - Validaciones de contrato\n‚Ä¢ @dailyTests - Pruebas diarias\n\nPuedes ver m√°s tags en los archivos .feature del proyecto',
                '¬øc√≥mo veo los reportes?': 'üìä Para ver los reportes:\n1. En el historial de ejecuciones, haz clic en cualquier enlace de reporte\n2. Se abrir√° el reporte completo de Karate con resultados detallados\n3. Tambi√©n recibir√°s los resultados por correo electr√≥nico\n4. Los reportes se conservan durante 14 d√≠as',
                'ayuda': 'üí° Puedo ayudarte con:\n‚Ä¢ C√≥mo ejecutar pruebas\n‚Ä¢ Informaci√≥n sobre tokens PAT\n‚Ä¢ Tags disponibles\n‚Ä¢ Visualizaci√≥n de reportes\n‚Ä¢ Diferencias entre ambientes QA y DEV\n\n¬øSobre qu√© tema necesitas ayuda?',
                'qa': 'üß™ QA es el ambiente de Quality Assurance donde se ejecutan las pruebas antes de producci√≥n. Es un entorno controlado para validar funcionalidades.',
                'dev': 'üë®‚Äçüíª DEV es el ambiente de desarrollo donde los desarrolladores prueban sus cambios antes de pasar a QA. Es m√°s inestable que QA.',
                'ambiente': 'üåç Tenemos dos ambientes:\n‚Ä¢ DEV: Desarrollo, para pruebas tempranas\n‚Ä¢ QA: Quality Assurance, para validaci√≥n final\n\nSelecciona QA para pruebas estables.',
                'correo': 'üìß El correo de notificaci√≥n es donde recibir√°s:\n‚Ä¢ Confirmaci√≥n de inicio de pruebas\n‚Ä¢ Resultados detallados al finalizar\n‚Ä¢ Enlaces directos a los reportes\n\nPuedes usar cualquier correo v√°lido.',
                'default': 'ü§î No estoy seguro de c√≥mo responder a eso. Intenta preguntar sobre:\n‚Ä¢ Ejecuci√≥n de pruebas\n‚Ä¢ Tokens PAT\n‚Ä¢ Tags disponibles\n‚Ä¢ Reportes\n‚Ä¢ Ambientes\n\nO escribe "ayuda" para ver todas las opciones.'
              };
              
              chatbotButton.addEventListener('click', () => {
                chatbotWindow.classList.toggle('active');
                if (chatbotWindow.classList.contains('active')) {
                  chatbotInput.focus();
                }
              });
              
              chatbotClose.addEventListener('click', () => {
                chatbotWindow.classList.remove('active');
              });
              
              function addMessage(text, isBot = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = \`chat-message \${isBot ? 'bot' : 'user'}\`;
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = \`chat-bubble \${isBot ? 'bot' : 'user'}\`;
                bubbleDiv.textContent = text;
                bubbleDiv.style.whiteSpace = 'pre-line';
                
                messageDiv.appendChild(bubbleDiv);
                
                const quickQuestions = chatbotMessages.querySelector('.quick-questions');
                chatbotMessages.insertBefore(messageDiv, quickQuestions);
                
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
              }
              
              function getBotResponse(userMessage) {
                const normalized = userMessage.toLowerCase().trim();
                
                for (const [key, value] of Object.entries(responses)) {
                  if (normalized.includes(key)) {
                    return value;
                  }
                }
                
                return responses['default'];
              }
              
              function handleUserMessage() {
                const userMessage = chatbotInput.value.trim();
                if (!userMessage) return;
                
                addMessage(userMessage, false);
                chatbotInput.value = '';
                
                setTimeout(() => {
                  const botResponse = getBotResponse(userMessage);
                  addMessage(botResponse, true);
                }, 500);
              }
              
              chatbotSend.addEventListener('click', handleUserMessage);
              
              chatbotInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                  handleUserMessage();
                }
              });
              
              quickQuestionBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                  const question = btn.dataset.question;
                  addMessage(question, false);
                  
                  setTimeout(() => {
                    const botResponse = getBotResponse(question);
                    addMessage(botResponse, true);
                  }, 500);
                });
              });
            </script>
          </body>
          </html>
          EOF

      - name: üåê Publicar √≠ndice en GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-temp
          keep_files: true

      - name: üïê Capturar fecha de fin
        id: fecha_fin
        if: always()
        run: |
          echo "datetime=$(TZ=America/Lima date '+%d/%m/%Y %H:%M:%S %Z')" >> $GITHUB_OUTPUT
          echo "year=$(TZ=America/Lima date '+%Y')" >> $GITHUB_OUTPUT

      - name: ‚úâÔ∏è Notificar FIN de ejecuci√≥n (con tabla y link al artefacto)
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ steps.setup.outputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üü¢ Resultados de Pruebas Karate ‚Äì ${{ steps.setup.outputs.tag }}"
          html_body: |
            <!DOCTYPE html>
            <html lang="es">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
            </head>
            <body style="margin: 0; padding: 0; background-color: #f5f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
              <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f5f7fa;">
                <tr>
                  <td align="center" style="padding: 40px 20px;">
                    <table width="600" cellpadding="0" cellspacing="0" border="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
                      
                      <!-- Header con logo -->
                      <tr>
                        <td style="background: linear-gradient(135deg, #34a853 0%, #1e8e3e 100%); padding: 30px; text-align: center;">
                          <img src="https://res.cloudinary.com/dvrsdqsl1/image/upload/v1764399269/Blue_Minimalist_Technology_Cube_Logo_1_x445ab.png" alt="Logo" style="max-width: 120px; height: auto; margin-bottom: 15px;">
                          <h1 style="color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;">üü¢ Resultados de Pruebas</h1>
                        </td>
                      </tr>
                      
                      <!-- Contenido -->
                      <tr>
                        <td style="padding: 40px 30px;">
                          <p style="color: #333333; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
                            Estimado/a,
                          </p>
                          <p style="color: #555555; font-size: 15px; line-height: 1.6; margin: 0 0 30px 0;">
                            La ejecuci√≥n de pruebas <strong style="color: #34a853;">Karate API</strong> ha finalizado. A continuaci√≥n encontrar√°s el resumen de resultados:
                          </p>
                          
                          <!-- Estado general -->
                          <div style="background: ${{ steps.karate.outputs.karate_failed == 'true' && 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)' || 'linear-gradient(135deg, #34a853 0%, #1e8e3e 100%)' }}; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 30px;">
                            <p style="color: #ffffff; font-size: 18px; font-weight: 600; margin: 0;">
                              Estado: ${{ steps.karate.outputs.karate_failed == 'true' && '‚ùå FALL√ì' || '‚úÖ EXITOSO' }}
                            </p>
                          </div>
                          
                          <!-- Informaci√≥n de ejecuci√≥n -->
                          <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f8f9fa; border-radius: 8px; overflow: hidden; margin-bottom: 30px;">
                            <tr>
                              <td style="padding: 20px;">
                                <table width="100%" cellpadding="8" cellspacing="0" border="0">
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; width: 35%;">üè∑Ô∏è Tag ejecutado:</td>
                                    <td style="color: #34a853; font-size: 14px; font-weight: 600;">${{ steps.setup.outputs.tag }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üåç Ambiente:</td>
                                    <td style="color: #34a853; font-size: 14px; font-weight: 600; padding-top: 10px;">${{ steps.setup.outputs.ambiente }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üìÖ Fecha/Hora:</td>
                                    <td style="color: #333333; font-size: 14px; padding-top: 10px;">${{ steps.fecha_fin.outputs.datetime }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üî¢ Ejecuci√≥n #:</td>
                                    <td style="color: #333333; font-size: 14px; padding-top: 10px;">${{ github.run_number }}</td>
                                  </tr>
                                </table>
                              </td>
                            </tr>
                          </table>
                          
                          <!-- Resumen de escenarios -->
                          <h3 style="color: #333333; font-size: 18px; margin: 0 0 15px 0; border-bottom: 2px solid #34a853; padding-bottom: 10px;">
                            üìä Resumen de Escenarios
                          </h3>
                          <div style="overflow-x: auto; margin-bottom: 30px;">
                            ${{ steps.table.outputs.summary_table }}
                          </div>
                          
                          <!-- Bot√≥n de acci√≥n -->
                          <table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin: 30px 0;">
                            <tr>
                              <td align="center">
                                <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/karate-summary.html" style="background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%); color: #ffffff; text-decoration: none; padding: 14px 28px; border-radius: 6px; font-weight: 600; font-size: 15px; display: inline-block; box-shadow: 0 2px 8px rgba(26,115,232,0.3);">
                                  üåê Ver Reporte Completo
                                </a>
                              </td>
                            </tr>
                          </table>
                          
                          <!-- Nota informativa -->
                          <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <p style="color: #856404; font-size: 13px; margin: 0; line-height: 1.5;">
                              <strong>üì¶ Nota:</strong> Tambi√©n puedes descargar los artefactos del reporte desde la secci√≥n de artefactos en GitHub Actions.
                            </p>
                          </div>
                          
                          <p style="color: #555555; font-size: 14px; line-height: 1.6; margin: 20px 0 0 0;">
                            Saludos cordiales,<br>
                            <strong style="color: #34a853;">Sistema Autom√°tico de QA</strong>
                          </p>
                        </td>
                      </tr>
                      
                      <!-- Footer -->
                      <tr>
                        <td style="background-color: #f8f9fa; padding: 20px 30px; border-top: 1px solid #e0e0e0;">
                          <p style="color: #999999; font-size: 12px; margin: 0; text-align: center;">
                            GitHub Actions ¬∑ Testing Continuo ¬∑ ${{ steps.fecha_fin.outputs.year }}
                          </p>
                          <p style="color: #999999; font-size: 11px; margin: 10px 0 0 0; text-align: center;">
                            <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" style="color: #1a73e8; text-decoration: none;">Ver Historial de Reportes</a>
                          </p>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </body>
            </html>