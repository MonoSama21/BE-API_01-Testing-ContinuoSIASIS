name: üöÄ Karate API Tests - Manual & Scheduled

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de pruebas a ejecutar (ej: @login, @security)"
        required: true
        type: string
      ambiente:
        description: "Ambiente a ejecutar (DEV o QA)"
        required: true
        type: choice
        options:
          - DEV
          - QA
        default: QA
      correo:
        description: "Correo donde llegar√°n las notificaciones"
        required: true
        type: string
  
  schedule:
    # Lunes a Viernes a las 8 AM (Per√∫ UTC-5 = 13:00 UTC)
    - cron: '0 13 * * 1-5'
    # S√°bados y Domingos a las 10 AM (Per√∫ UTC-5 = 15:00 UTC)
    - cron: '0 15 * * 0,6'

jobs:
  run-karate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:

      - name: üéØ Determinar tag y par√°metros seg√∫n trigger
        id: setup
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # Detectar qu√© cron se ejecut√≥ basado en la hora UTC
            HOUR=$(date -u +%H)
            DAY=$(date -u +%u)  # 1=Lunes, 7=Domingo
            
            if [ "$HOUR" = "13" ] && [ "$DAY" -ge 1 ] && [ "$DAY" -le 5 ]; then
              # Lunes a Viernes a las 13:00 UTC (8 AM Per√∫)
              echo "tag=@dailyTests" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "15" ] && ([ "$DAY" = "6" ] || [ "$DAY" = "7" ]); then
              # S√°bado o Domingo a las 15:00 UTC (10 AM Per√∫)
              echo "tag=@postLoginRolAuxiliar" >> $GITHUB_OUTPUT
            else
              echo "tag=@dailyTests" >> $GITHUB_OUTPUT
            fi
            echo "ambiente=QA" >> $GITHUB_OUTPUT
            echo "correo=2101010261@undc.edu.pe" >> $GITHUB_OUTPUT
          else
            # Ejecuci√≥n manual
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
            echo "ambiente=${{ github.event.inputs.ambiente }}" >> $GITHUB_OUTPUT
            echo "correo=${{ github.event.inputs.correo }}" >> $GITHUB_OUTPUT
          fi

      - name: üì• Checkout del repositorio
        uses: actions/checkout@v4

      - name: ‚òï Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: üïê Capturar fecha de inicio
        id: fecha_inicio
        run: |
          echo "datetime=$(TZ=America/Lima date '+%d/%m/%Y %H:%M:%S %Z')" >> $GITHUB_OUTPUT
          echo "year=$(TZ=America/Lima date '+%Y')" >> $GITHUB_OUTPUT

      - name: ‚úâÔ∏è Notificar INICIO de ejecuci√≥n
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ steps.setup.outputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üîµ Inicio de Pruebas Karate ‚Äì ${{ steps.setup.outputs.tag }}"
          html_body: |
            <!DOCTYPE html>
            <html lang="es">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
            </head>
            <body style="margin: 0; padding: 0; background-color: #f5f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
              <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f5f7fa;">
                <tr>
                  <td align="center" style="padding: 40px 20px;">
                    <table width="600" cellpadding="0" cellspacing="0" border="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
                      
                      <!-- Header con logo -->
                      <tr>
                        <td style="background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%); padding: 30px; text-align: center;">
                          <img src="https://res.cloudinary.com/dvrsdqsl1/image/upload/v1764399269/Blue_Minimalist_Technology_Cube_Logo_1_x445ab.png" alt="Logo" style="max-width: 120px; height: auto; margin-bottom: 15px;">
                          <h1 style="color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;">üîµ Ejecuci√≥n de Pruebas Iniciada</h1>
                        </td>
                      </tr>
                      
                      <!-- Contenido -->
                      <tr>
                        <td style="padding: 40px 30px;">
                          <p style="color: #333333; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
                            Estimado/a,
                          </p>
                          <p style="color: #555555; font-size: 15px; line-height: 1.6; margin: 0 0 30px 0;">
                            Se ha iniciado la ejecuci√≥n autom√°tica de pruebas <strong style="color: #1a73e8;">Karate API</strong> en el sistema de testing continuo.
                          </p>
                          
                          <!-- Informaci√≥n de ejecuci√≥n -->
                          <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f8f9fa; border-radius: 8px; overflow: hidden; margin-bottom: 30px;">
                            <tr>
                              <td style="padding: 20px;">
                                <table width="100%" cellpadding="8" cellspacing="0" border="0">
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; width: 35%;">üè∑Ô∏è Tag seleccionado:</td>
                                    <td style="color: #1a73e8; font-size: 14px; font-weight: 600;">${{ steps.setup.outputs.tag }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üåç Ambiente:</td>
                                    <td style="color: #1a73e8; font-size: 14px; font-weight: 600; padding-top: 10px;">${{ steps.setup.outputs.ambiente }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üìÖ Fecha/Hora:</td>
                                    <td style="color: #333333; font-size: 14px; padding-top: 10px;">${{ steps.fecha_inicio.outputs.datetime }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üî¢ Ejecuci√≥n #:</td>
                                    <td style="color: #333333; font-size: 14px; padding-top: 10px;">${{ github.run_number }}</td>
                                  </tr>
                                </table>
                              </td>
                            </tr>
                          </table>
                          
                          <!-- Nota informativa -->
                          <div style="background-color: #e3f2fd; border-left: 4px solid #1a73e8; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <p style="color: #1565c0; font-size: 14px; margin: 0; line-height: 1.5;">
                              <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Recibir√°s una notificaci√≥n autom√°tica con los resultados cuando la ejecuci√≥n finalice.
                            </p>
                          </div>
                          
                          <p style="color: #555555; font-size: 14px; line-height: 1.6; margin: 20px 0 0 0;">
                            Saludos cordiales,<br>
                            <strong style="color: #1a73e8;">Sistema Autom√°tico de QA</strong>
                          </p>
                        </td>
                      </tr>
                      
                      <!-- Footer -->
                      <tr>
                        <td style="background-color: #f8f9fa; padding: 20px 30px; border-top: 1px solid #e0e0e0;">
                          <p style="color: #999999; font-size: 12px; margin: 0; text-align: center;">
                            GitHub Actions ¬∑ Testing Continuo ¬∑ ${{ steps.fecha_inicio.outputs.year }}
                          </p>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </body>
            </html>


      - name: üì¶ Instalar dependencias
        run: mvn clean install -DskipTests

      - name: üß™ Ejecutar pruebas Karate con tag
        id: karate
        run: |
          echo "karate_failed=false" >> $GITHUB_OUTPUT
          mvn test -Dkarate.options="--tags ${{ steps.setup.outputs.tag }}" -Dkarate.env=${{ steps.setup.outputs.ambiente }} || echo "karate_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      # Detectar din√°micamente el JSON resumen (var√≠a por versiones)
      - name: üîç Detectar archivo de resumen Karate (busca primero)
        id: detect
        run: |
          FILE=$(find target -type f -name "karate-summary-json.txt" -o -name "karate-summary.json" | head -n 1)
          if [ -z "$FILE" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ karate-summary-json.txt ni karate-summary.json"
            echo "file_summary=" >> $GITHUB_OUTPUT
          else
            echo "Resumen encontrado en: $FILE"
            echo "file_summary=$FILE" >> $GITHUB_OUTPUT
          fi
          
      - name: üìù Generar tabla HTML de resultados (desde HTML Karate)
        id: table
        run: |
          REPORT_DIR="target/karate-reports"

          echo "<table border='1' cellspacing='0' cellpadding='6' style='border-collapse:collapse;'>" > table.html
          echo "<tr style='background:#f2f2f2; font-weight:bold;'><th>Escenario</th><th>Estado</th></tr>" >> table.html

          # Buscar todos los HTML de Karate
          for f in $(find "$REPORT_DIR" -type f -name "*.html"); do

            # Extraer nombres de escenarios
            sed -n 's/.*scenario-name">\(.*\)<\/.*/\1/p' "$f" > names.txt

            # Extraer estado usando clase scenario-time passed / failed
            sed -n 's/.*scenario-time \(passed\|failed\).*/\1/p' "$f" > status.txt

            # Combinar ambas listas
            paste names.txt status.txt | while IFS=$'\t' read -r name status; do

              # PASSED o FAILED en may√∫scula
              STATUS_UPPER=$(echo "$status" | tr '[:lower:]' '[:upper:]')

              # Color visual
              if [ "$STATUS_UPPER" = "PASSED" ]; then
                COLOR="green"
              else
                COLOR="red"
              fi

              echo "<tr>
                      <td>$name</td>
                      <td style='color:$COLOR; font-weight:bold;'>$STATUS_UPPER</td>
                    </tr>" >> table.html

            done

          done

          rm -f names.txt status.txt || true

          echo "</table>" >> table.html

          SUMMARY=$(cat table.html)
          echo "summary_table<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üìä Publicar resultados en GitHub Summary
        if: always()
        run: |
          echo "# üìä Resultados de Pruebas Karate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Informaci√≥n de Ejecuci√≥n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Par√°metro | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| üè∑Ô∏è Tag ejecutado | \`${{ steps.setup.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üåç Ambiente | \`${{ steps.setup.outputs.ambiente }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üìÖ Fecha/Hora | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Estado | ${{ steps.karate.outputs.karate_failed == 'true' && '‚ùå FAILED' || '‚úÖ PASSED' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üß™ Resultados por Escenario" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Generar tabla en formato Markdown para GitHub
          echo "| Escenario | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          REPORT_DIR="target/karate-reports"
          for f in $(find "$REPORT_DIR" -type f -name "*.html" 2>/dev/null); do
            sed -n 's/.*scenario-name">\(.*\)<\/.*/\1/p' "$f" > names_summary.txt
            sed -n 's/.*scenario-time \(passed\|failed\).*/\1/p' "$f" > status_summary.txt
            
            paste names_summary.txt status_summary.txt | while IFS=$'\t' read -r name status; do
              STATUS_UPPER=$(echo "$status" | tr '[:lower:]' '[:upper:]')
              if [ "$STATUS_UPPER" = "PASSED" ]; then
                EMOJI="‚úÖ"
              else
                EMOJI="‚ùå"
              fi
              echo "| $name | $EMOJI $STATUS_UPPER |" >> $GITHUB_STEP_SUMMARY
            done
          done
          
          rm -f names_summary.txt status_summary.txt || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîó Enlaces √ötiles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üìÑ [Ver reporte completo en GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/karate-summary.html)" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ [Descargar artefactos](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY



      # Crear una carpeta con SOLO los archivos del reporte (para evitar nested-zip)
      - name: üìÅ Empaquetar √∫nicamente los archivos del reporte (sin .jar/.class/etc)
        run: |
          rm -rf karate-report-package || true
          mkdir karate-report-package
          # Si existe, copiar toda la carpeta karate-reports (estilos, html, imgs)
          if [ -d "target/karate-reports" ]; then
            cp -r target/karate-reports/* karate-report-package/ || true
          else
            echo "‚ö†Ô∏è No existe target/karate-reports; nada para empaquetar"
          fi
          # opcional: eliminar archivos potencialmente bloqueados por Gmail dentro de la carpeta
          find karate-report-package -type f \( -iname "*.jar" -o -iname "*.class" -o -iname "*.sh" -o -iname "*.exe" -o -iname "*.bat" -o -iname "*.cmd" \) -delete || true
          # verifica contenido
          echo "Contenido de karate-report-package:"
          ls -R karate-report-package || true

      # SUBIR la carpeta como ARTIFACT (esto generar√° UN solo ZIP cuyo contenido son los archivos del reporte)
      - name: üì§ Subir carpeta del reporte como artefacto (genera 1 ZIP en GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: karate-report
          path: karate-report-package
          retention-days: 14

      - name: üìã Crear metadata del reporte
        if: always()
        run: |
          # Configurar zona horaria de Per√∫
          export TZ=America/Lima
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Crear archivo de metadata JSON
          cat > karate-report-package/metadata.json << EOF
          {
            "run_number": "${{ github.run_number }}",
            "tag": "${{ steps.setup.outputs.tag }}",
            "ambiente": "${{ steps.setup.outputs.ambiente }}",
            "fecha": "${CURRENT_DATE}",
            "timezone": "America/Lima"
          }
          EOF
          
          echo "Metadata creado para reporte #${{ github.run_number }}"
          cat karate-report-package/metadata.json

      - name: üåê Publicar reporte en GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./karate-report-package
          destination_dir: reports/${{ github.run_number }}
          keep_files: true

      - name: üìù Crear √≠ndice de reportes con historial completo
        if: always()
        run: |
          # Configurar zona horaria de Per√∫
          export TZ=America/Lima
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Checkout de la rama gh-pages para leer reportes existentes
          git fetch origin gh-pages:gh-pages || true
          git checkout gh-pages || true
          
          # Obtener lista de reportes existentes
          REPORTS_DIRS=$(find reports -mindepth 1 -maxdepth 1 -type d 2>/dev/null | sort -rn || echo "")
          
          # Volver a la rama de trabajo
          git checkout -
          
          # Crear carpeta temporal
          mkdir -p gh-pages-temp
          
          # Generar fecha actual
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Crear HTML con historial completo
          # Crear el archivo CSS
          cat > gh-pages-temp/style.css << 'CSSEOF'
            * { margin: 0; padding: 0; box-sizing: border-box; }

            body {
              font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              min-height: 100vh;
              padding: 20px;
            }

            .dashboard { max-width: 1400px; margin: 0 auto; }

            .header {
              background: rgba(255, 255, 255, 0.98);
              backdrop-filter: blur(10px);
              border-radius: 20px;
              padding: 30px;
              margin-bottom: 30px;
              box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
              display: flex;
              justify-content: space-between;
              align-items: center;
            }

            .header h1 {
              color: #2d3748;
              font-size: 2rem;
              font-weight: 700;
              display: flex;
              align-items: center;
              gap: 15px;
            }

            .header h1::before { content: "üéØ"; font-size: 2.5rem; }

            .help-btn {
              background: linear-gradient(135deg, #667eea, #764ba2);
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 12px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.3s;
              box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }

            .help-btn:hover {
              transform: translateY(-2px);
              box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            }

            .grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 25px;
              margin-bottom: 25px;
            }

            @media (max-width: 768px) {
              .grid { grid-template-columns: 1fr; }
            }

            .card {
              background: rgba(255, 255, 255, 0.98);
              backdrop-filter: blur(10px);
              border-radius: 20px;
              padding: 30px;
              box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
              transition: transform 0.3s, box-shadow 0.3s;
            }

            .card:hover {
              transform: translateY(-5px);
              box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            }

            .card h2 {
              color: #2d3748;
              font-size: 1.5rem;
              margin-bottom: 20px;
              display: flex;
              align-items: center;
              gap: 10px;
            }

            .executor-card {
              background: linear-gradient(135deg, rgba(52, 168, 83, 0.1), rgba(200, 230, 201, 0.2));
              border-left: 5px solid #34a853;
            }

            .stats-card { border-left: 5px solid #667eea; }

            .stats-grid {
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 15px;
              margin-top: 15px;
            }

            .stat-item {
              background: rgba(255, 255, 255, 0.5);
              padding: 15px;
              border-radius: 12px;
              text-align: center;
            }

            .stat-value {
              font-size: 2rem;
              font-weight: 700;
              color: #667eea;
            }

            .stat-label {
              font-size: 0.85rem;
              color: #718096;
              margin-top: 5px;
            }

            .form-group { margin-bottom: 18px; }

            .form-group label {
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #2d3748;
              font-size: 0.95rem;
            }

            .form-group input,
            .form-group select {
              width: 100%;
              padding: 14px 16px;
              border: 2px solid #e2e8f0;
              border-radius: 12px;
              font-size: 14px;
              transition: all 0.3s;
              background: white;
              font-family: inherit;
            }

            .form-group input:focus,
            .form-group select:focus {
              outline: none;
              border-color: #667eea;
              box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
              transform: translateY(-1px);
            }

            .btn-execute {
              background: linear-gradient(135deg, #667eea, #764ba2);
              color: white;
              padding: 16px 32px;
              border: none;
              border-radius: 12px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 700;
              width: 100%;
              transition: all 0.3s;
              box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }

            .btn-execute:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
            }

            .btn-execute:active { transform: translateY(0); }

            .btn-execute:disabled {
              background: #cbd5e0;
              cursor: not-allowed;
              box-shadow: none;
            }

            .message {
              padding: 16px 20px;
              border-radius: 12px;
              margin-top: 20px;
              display: none;
              font-weight: 500;
              animation: slideIn 0.3s;
            }

            @keyframes slideIn {
              from { opacity: 0; transform: translateX(-20px); }
              to { opacity: 1; transform: translateX(0); }
            }

            .message.success {
              background: #d4edda;
              color: #155724;
              border-left: 4px solid #28a745;
            }

            .message.error {
              background: #f8d7da;
              color: #721c24;
              border-left: 4px solid #dc3545;
            }

            .message.show { display: block; }

            .reports-section {
              background: rgba(255, 255, 255, 0.98);
              backdrop-filter: blur(10px);
              border-radius: 20px;
              padding: 30px;
              box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            }

            .reports-section h2 {
              color: #2d3748;
              font-size: 1.8rem;
              margin-bottom: 25px;
              display: flex;
              align-items: center;
              gap: 10px;
            }

            .report-list {
              list-style: none;
              padding: 0;
            }

            .report-item {
              background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.95));
              padding: 20px 25px;
              margin: 15px 0;
              border-radius: 15px;
              box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
              transition: all 0.3s;
              border-left: 5px solid #667eea;
              display: flex;
              justify-content: space-between;
              align-items: center;
            }

            .report-item:hover {
              transform: translateX(10px);
              box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }

            .report-link {
              color: #667eea;
              text-decoration: none;
              font-size: 1.1rem;
              font-weight: 700;
              transition: color 0.3s;
            }

            .report-link:hover { color: #764ba2; }

            .report-meta {
              display: flex;
              flex-direction: column;
              gap: 5px;
            }

            .report-date {
              color: #718096;
              font-size: 0.9rem;
              font-weight: 500;
            }

            .badge {
              display: inline-block;
              padding: 6px 14px;
              border-radius: 20px;
              font-size: 0.75rem;
              font-weight: 700;
              text-transform: uppercase;
              margin-left: 10px;
            }

            .badge-new {
              background: linear-gradient(135deg, #34a853, #2d9e47);
              color: white;
              box-shadow: 0 2px 8px rgba(52, 168, 83, 0.4);
              animation: pulse 2s infinite;
            }

            @keyframes pulse {
              0%, 100% { transform: scale(1); }
              50% { transform: scale(1.05); }
            }

            .info-text {
              color: #718096;
              font-size: 0.85rem;
              margin-top: 6px;
            }

            .info-text a {
              color: #667eea;
              font-weight: 600;
              text-decoration: none;
            }

            .info-text a:hover { text-decoration: underline; }

            .help-panel {
              position: fixed;
              top: 0;
              right: -500px;
              width: 450px;
              height: 100vh;
              background: white;
              box-shadow: -5px 0 30px rgba(0, 0, 0, 0.3);
              transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
              z-index: 1000;
              overflow-y: auto;
            }

            .help-panel.active { right: 0; }

            .help-header {
              background: linear-gradient(135deg, #667eea, #764ba2);
              color: white;
              padding: 25px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              position: sticky;
              top: 0;
              z-index: 10;
            }

            .help-header h2 {
              font-size: 1.5rem;
              display: flex;
              align-items: center;
              gap: 10px;
              color: white;
            }

            .close-btn {
              background: rgba(255, 255, 255, 0.2);
              border: none;
              color: white;
              width: 35px;
              height: 35px;
              border-radius: 50%;
              cursor: pointer;
              font-size: 20px;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: background 0.3s;
            }

            .close-btn:hover { background: rgba(255, 255, 255, 0.3); }

            .help-content { padding: 25px; }

            .help-section { margin-bottom: 30px; }

            .help-section h3 {
              color: #2d3748;
              font-size: 1.2rem;
              margin-bottom: 15px;
              padding-bottom: 10px;
              border-bottom: 3px solid #667eea;
              display: flex;
              align-items: center;
              gap: 10px;
            }

            .help-item {
              background: linear-gradient(135deg, #f7fafc, #edf2f7);
              padding: 15px 20px;
              margin: 10px 0;
              border-radius: 12px;
              border-left: 4px solid #667eea;
              transition: transform 0.2s;
            }

            .help-item:hover { transform: translateX(5px); }

            .help-item h4 {
              color: #2d3748;
              font-size: 1rem;
              margin-bottom: 8px;
              font-weight: 600;
            }

            .help-item p {
              color: #4a5568;
              font-size: 0.9rem;
              line-height: 1.6;
              margin: 5px 0;
            }

            .help-item code {
              background: #667eea;
              color: white;
              padding: 2px 8px;
              border-radius: 6px;
              font-size: 0.85rem;
              font-weight: 600;
            }

            .quick-stats {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 10px;
              margin: 20px 0;
            }

            .quick-stat {
              background: linear-gradient(135deg, #667eea, #764ba2);
              color: white;
              padding: 15px;
              border-radius: 12px;
              text-align: center;
              box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .quick-stat-value {
              font-size: 1.8rem;
              font-weight: 700;
            }

            .quick-stat-label {
              font-size: 0.75rem;
              opacity: 0.9;
              margin-top: 5px;
            }
          CSSEOF
          
          # Crear el archivo HTML principal
          cat > gh-pages-temp/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Dashboard QA - Karate Testing</title>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
            <link href="style.css" rel="stylesheet">
          </head>
          <body>
            <div class="dashboard">
              <div class="header">
                <h1>Dashboard QA - Karate Testing</h1>
                <button class="help-btn" onclick="toggleHelp()">Centro de Ayuda</button>
              </div>

              <div class="grid">
                <div class="card executor-card">
                  <h2>Ejecutar Nuevas Pruebas</h2>
                  <form id="executionForm">
                    <div class="form-group">
                      <label for="githubToken">GitHub Token (PAT)</label>
                      <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" required>
                      <p class="info-text">Necesitas un Personal Access Token con permiso workflow</p>
                    </div>
                    
                    <div class="form-group">
                      <label for="tag">Tag a ejecutar</label>
                      <input type="text" id="tag" placeholder="postLoginRolDirectivo" required>
                      <p class="info-text">Ejemplo: login, security, smoke</p>
                    </div>
                    
                    <div class="form-group">
                      <label for="ambiente">Ambiente</label>
                      <select id="ambiente" required>
                        <option value="QA" selected>QA (Quality Assurance)</option>
                        <option value="DEV">DEV (Desarrollo)</option>
                      </select>
                    </div>
                    
                    <div class="form-group">
                      <label for="correo">Correo de notificacion</label>
                      <input type="email" id="correo" placeholder="tu-correo@ejemplo.com" value="2101010261@undc.edu.pe" required>
                    </div>
                    
                    <button type="submit" class="btn-execute" id="btnExecute">
                      Ejecutar Pruebas Ahora
                    </button>
                    
                    <div id="message" class="message"></div>
                  </form>
                </div>

                <div class="card stats-card">
                  <h2>Estadisticas</h2>
                  <div class="stats-grid">
                    <div class="stat-item">
                      <div class="stat-value">RUN_NUM_PLACEHOLDER</div>
                      <div class="stat-label">Ultimo Reporte</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-value">TAG_PLACEHOLDER</div>
                      <div class="stat-label">Ultimo Tag</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-value">AMB_PLACEHOLDER</div>
                      <div class="stat-label">Ambiente</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-value">FECHA_PLACEHOLDER</div>
                      <div class="stat-label">Ultima Ejecucion</div>
                    </div>
                  </div>
                  <div class="quick-stats">
                    <div class="quick-stat">
                      <div class="quick-stat-value">QA</div>
                      <div class="quick-stat-label">Testing</div>
                    </div>
                    <div class="quick-stat">
                      <div class="quick-stat-value">API</div>
                      <div class="quick-stat-label">Karate</div>
                    </div>
                    <div class="quick-stat">
                      <div class="quick-stat-value">CI/CD</div>
                      <div class="quick-stat-label">Automation</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="reports-section">
                <h2>Historial de Ejecuciones</h2>
                <ul class="report-list">
          HTMLEOF
          
          # Agregar reporte actual
          RUN_NUM="${{ github.run_number }}"
          TAG="${{ steps.setup.outputs.tag }}"
          AMBIENTE="${{ steps.setup.outputs.ambiente }}"
          FECHA="${CURRENT_DATE}"
          
          cat >> gh-pages-temp/index.html << EOF
                <li class="report-item">
                  <div class="report-meta">
                    <a class="report-link" href="reports/$RUN_NUM/karate-summary.html">
                      Reporte #$RUN_NUM - Tag: $TAG
                    </a>
                    <span class="report-date">Ambiente: $AMBIENTE | Fecha: $FECHA</span>
                  </div>
                  <span class="badge badge-new">NUEVO</span>
                </li>
          EOF
                      <option value="QA" selected>QA</option>
                      <option value="DEV">DEV</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="correo">Correo de notificaci√≥n</label>
                    <input type="email" id="correo" placeholder="tu-correo@ejemplo.com" value="2101010261@undc.edu.pe" required>
                  </div>
                  
                  <button type="submit" class="btn-execute" id="btnExecute">
                    ‚ñ∂Ô∏è Ejecutar Pruebas
                  </button>
                  
                  <div id="message" class="message"></div>
                </form>
              </div>
              
              <div class="stats">
                <p><strong>√öltimo reporte generado:</strong> Run #${{ github.run_number }}</p>
                <p><strong>Tag:</strong> ${{ steps.setup.outputs.tag }}</p>
                <p><strong>Ambiente:</strong> ${{ steps.setup.outputs.ambiente }}</p>
                <p><strong>Fecha:</strong> ${CURRENT_DATE}</p>
              </div>
              
              <h2>üìã Historial de Ejecuciones</h2>
              <ul class="report-list">
          EOF
          
          # Agregar reporte actual primero
          cat >> gh-pages-temp/index.html << 'REPORTEOF'
                <li class="report-item">
                  <div class="report-meta">
                    <a class="report-link" href="reports/$RUN_NUM/karate-summary.html">
                      üìÑ Reporte #$RUN_NUM - Tag: $TAG
                    </a>
                    <span class="report-date">Ambiente: $AMBIENTE | Fecha: $FECHA</span>
                  </div>
                  <span class="badge badge-new">NUEVO</span>
                </li>
          REPORTEOF
          
          # Agregar reportes anteriores
          if [ -n "$REPORTS_DIRS" ]; then
            for report_dir in $REPORTS_DIRS; do
              RUN_NUM=$(basename "$report_dir")
              # Evitar duplicar el reporte actual
              if [ "$RUN_NUM" != "${{ github.run_number }}" ]; then
                # Intentar leer metadata del reporte
                METADATA_FILE="$report_dir/metadata.json"
                if [ -f "$METADATA_FILE" ]; then
                  TAG=$(grep -oP '"tag":\s*"\K[^"]+' "$METADATA_FILE" 2>/dev/null || echo "N/A")
                  AMBIENTE=$(grep -oP '"ambiente":\s*"\K[^"]+' "$METADATA_FILE" 2>/dev/null || echo "N/A")
                  FECHA=$(grep -oP '"fecha":\s*"\K[^"]+' "$METADATA_FILE" 2>/dev/null || echo "N/A")
                  
                  cat >> gh-pages-temp/index.html << 'OLDEOF'
              <li class="report-item">
                <div class="report-meta">
                  <a class="report-link" href="$REPORT_DIR/karate-summary.html">
                    üìÑ Reporte #$RUN - Tag: $TAG_VAL
                  </a>
                  <span class="report-date">Ambiente: $AMB | Fecha: $FECH</span>
                </div>
              </li>
          OLDEOF
                  sed -i "s|\$REPORT_DIR|$report_dir|g; s|\$RUN|$RUN_NUM|g; s|\$TAG_VAL|$TAG|g; s|\$AMB|$AMBIENTE|g; s|\$FECH|$FECHA|g" gh-pages-temp/index.html
                else
                  COMMIT_DATE=$(git log --all --format="%cd" --date=format:'%Y-%m-%d %H:%M:%S' --diff-filter=A -- "$report_dir" 2>/dev/null | head -n1)
                  
                  if [ -z "$COMMIT_DATE" ]; then
                    COMMIT_DATE=$(git log -1 --format="%cd" --date=format:'%Y-%m-%d %H:%M:%S' -- "$report_dir" 2>/dev/null)
                  fi
                  
                  if [ -z "$COMMIT_DATE" ]; then
                    COMMIT_DATE="Fecha no disponible"
                  fi
                  
                  cat >> gh-pages-temp/index.html << 'OLDEOF2'
              <li class="report-item">
                <div class="report-meta">
                  <a class="report-link" href="$REPORT_DIR/karate-summary.html">
                    üìÑ Reporte #$RUN
                  </a>
                  <span class="report-date">Reporte hist√≥rico | Fecha: $DATE</span>
                </div>
              </li>
          OLDEOF2
                  sed -i "s|\$REPORT_DIR|$report_dir|g; s|\$RUN|$RUN_NUM|g; s|\$DATE|$COMMIT_DATE|g" gh-pages-temp/index.html
                fi
              fi
            done
          fi
          
          # Cerrar HTML con panel de ayuda
          cat >> gh-pages-temp/index.html << 'HELPEOF'
              </ul>
            </div>

            <!-- Panel de Ayuda -->
            <div class="help-panel" id="helpPanel">
              <div class="help-header">
                <h2>‚ùì Centro de Ayuda</h2>
                <button class="close-btn" onclick="document.getElementById('helpPanel').classList.remove('active')">‚úï</button>
              </div>
              
              <div class="help-content">
                <div class="help-section">
                  <h3>üë®‚Äçüíª Para QA Testers</h3>
                  
                  <div class="help-item">
                    <h4>¬øC√≥mo ejecutar pruebas?</h4>
                    <p>1. Obt√©n tu <strong>GitHub Token</strong> desde Configuraci√≥n ‚Üí Developer settings ‚Üí Personal access tokens</p>
                    <p>2. Ingresa el tag de las pruebas que deseas ejecutar (ej. <code>@login</code>)</p>
                    <p>3. Selecciona el ambiente (QA o DEV)</p>
                    <p>4. Haz clic en "Ejecutar Pruebas Ahora"</p>
                  </div>
                  
                  <div class="help-item">
                    <h4>Tags disponibles</h4>
                    <p><code>@postLoginRolDirectivo</code> - Login de directivos</p>
                    <p><code>@postLoginRolAuxiliar</code> - Login de auxiliares</p>
                    <p><code>@security</code> - Pruebas de seguridad</p>
                    <p><code>@smoke</code> - Pruebas r√°pidas</p>
                    <p><code>@contract</code> - Validaci√≥n de contratos API</p>
                  </div>
                  
                  <div class="help-item">
                    <h4>Interpretaci√≥n de resultados</h4>
                    <p><strong>Verde:</strong> Todos los tests pasaron correctamente ‚úÖ</p>
                    <p><strong>Rojo:</strong> Hay fallos que requieren atenci√≥n ‚ùå</p>
                    <p><strong>Amarillo:</strong> Tests con advertencias ‚ö†Ô∏è</p>
                  </div>
                </div>

                <div class="help-section">
                  <h3>üõ†Ô∏è Para Desarrolladores</h3>
                  
                  <div class="help-item">
                    <h4>Estructura de pruebas Karate</h4>
                    <p>Las pruebas est√°n en <code>src/test/resources/features/</code></p>
                    <p>Los schemas de validaci√≥n en <code>functional/schema/</code></p>
                    <p>Configuraci√≥n en <code>karate-config.js</code></p>
                  </div>
                  
                  <div class="help-item">
                    <h4>A√±adir nuevas pruebas</h4>
                    <p>1. Crea un archivo .feature en la carpeta apropiada</p>
                    <p>2. Define el escenario con Given-When-Then</p>
                    <p>3. A√±ade tags para categorizaci√≥n (ej. <code>@misDatos</code>)</p>
                    <p>4. Valida respuestas con schemas JSON</p>
                  </div>
                  
                  <div class="help-item">
                    <h4>Schemas de validaci√≥n</h4>
                    <p>Usa <code>match response == schemas['200']</code> para validar respuestas exitosas</p>
                    <p>Los schemas soportan m√∫ltiples c√≥digos HTTP (200, 400, 401, 403, 404, 500)</p>
                  </div>
                </div>

                <div class="help-section">
                  <h3>üìä Para Product Owners</h3>
                  
                  <div class="help-item">
                    <h4>¬øQu√© es esto?</h4>
                    <p>Dashboard de automatizaci√≥n de pruebas API para el sistema SIASIS</p>
                    <p>Permite ejecutar y monitorear pruebas de calidad en tiempo real</p>
                  </div>
                  
                  <div class="help-item">
                    <h4>M√©tricas importantes</h4>
                    <p><strong>Cobertura:</strong> % de endpoints testeados</p>
                    <p><strong>Tasa de √©xito:</strong> % de pruebas que pasan</p>
                    <p><strong>Tiempo de ejecuci√≥n:</strong> Duraci√≥n del testing</p>
                  </div>
                  
                  <div class="help-item">
                    <h4>Reportes hist√≥ricos</h4>
                    <p>Accede al historial para ver tendencias y comparar resultados</p>
                    <p>Los reportes muestran detalles t√©cnicos de cada test ejecutado</p>
                  </div>
                </div>

                <div class="help-section">
                  <h3>üîë Configuraci√≥n Token</h3>
                  
                  <div class="help-item">
                    <h4>Crear Personal Access Token</h4>
                    <p>1. Ve a GitHub ‚Üí Settings ‚Üí Developer settings</p>
                    <p>2. Selecciona Personal access tokens ‚Üí Tokens (classic)</p>
                    <p>3. Click en "Generate new token"</p>
                    <p>4. Marca el scope <code>workflow</code></p>
                    <p>5. Copia el token generado (comienza con ghp_)</p>
                  </div>
                  
                  <div class="help-item">
                    <h4>Seguridad</h4>
                    <p>‚ö†Ô∏è <strong>NUNCA</strong> compartas tu token</p>
                    <p>üîí El token no se guarda en el navegador</p>
                    <p>‚ôªÔ∏è Regenera el token si crees que fue comprometido</p>
                  </div>
                </div>
              </div>
            </div>
          HELPEOF
          
          # Agregar JavaScript
          cat >> gh-pages-temp/index.html << 'JSEOF'
            <script>
              const form = document.getElementById('executionForm');
              const btnExecute = document.getElementById('btnExecute');
              const message = document.getElementById('message');
              
              form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const token = document.getElementById('githubToken').value.trim();
                const tag = document.getElementById('tag').value.trim();
                const ambiente = document.getElementById('ambiente').value;
                const correo = document.getElementById('correo').value.trim();
                
                if (!token || !tag || !correo) {
                  message.className = 'message error show';
                  message.textContent = 'Por favor completa todos los campos';
                  return;
                }
                
                if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                  message.className = 'message error show';
                  message.textContent = 'El token debe comenzar con ghp_ o github_pat_';
                  return;
                }
                
                if (!tag.startsWith('@')) {
                  message.className = 'message error show';
                  message.textContent = 'El tag debe comenzar con @';
                  return;
                }
                
                btnExecute.disabled = true;
                btnExecute.textContent = 'Ejecutando...';
                message.className = 'message';
                
                try {
                  const response = await fetch('https://api.github.com/repos/$REPO/actions/workflows/karate-manual.yml/dispatches', {
                    method: 'POST',
                    headers: {
                      'Accept': 'application/vnd.github.v3+json',
                      'Authorization': 'token ' + token,
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      ref: 'main',
                      inputs: {
                        tag,
                        ambiente,
                        correo
                      }
                    })
                  });
                  
                  if (response.status === 204) {
                    message.className = 'message success show';
                    message.textContent = 'Pruebas iniciadas correctamente. Recibir√°s notificaci√≥n por correo.';
                    form.reset();
                    document.getElementById('correo').value = '2101010261@undc.edu.pe';
                    setTimeout(() => location.reload(), 3000);
                  } else {
                    throw new Error('Error al iniciar workflow');
                  }
                } catch (error) {
                  message.className = 'message error show';
                  message.textContent = 'Error: ' + error.message;
                  btnExecute.disabled = false;
                  btnExecute.textContent = 'Ejecutar Pruebas Ahora';
                }
              });
            </script>
          </body>
          </html>
          JSEOF
          
          sed -i "s|\$REPO|${{ github.repository }}|g" gh-pages-temp/index.html
          sed -i "s|\$RUN_NUM|${{ github.run_number }}|g" gh-pages-temp/index.html
          sed -i "s|\$TAG|${{ steps.setup.outputs.tag }}|g" gh-pages-temp/index.html
          sed -i "s|\$AMBIENTE|${{ steps.setup.outputs.ambiente }}|g" gh-pages-temp/index.html
          sed -i "s|\$FECHA|${CURRENT_DATE}|g" gh-pages-temp/index.html
          
          # Copiar reportes al directorio temporal
          mkdir -p gh-pages-temp/reports/${{ github.run_number }}
          cp -r target/karate-reports/* gh-pages-temp/reports/${{ github.run_number }}/

      - name: üåê Publicar √≠ndice en GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-temp
          keep_files: true

      - name: üïê Capturar fecha de fin
        id: fecha_fin
        if: always()
        run: |
          echo "datetime=$(TZ=America/Lima date '+%d/%m/%Y %H:%M:%S %Z')" >> $GITHUB_OUTPUT
          echo "year=$(TZ=America/Lima date '+%Y')" >> $GITHUB_OUTPUT

      - name: ‚úâÔ∏è Notificar FIN de ejecuci√≥n (con tabla y link al artefacto)
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ steps.setup.outputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üü¢ Resultados de Pruebas Karate ‚Äì ${{ steps.setup.outputs.tag }}"
          html_body: |
            <!DOCTYPE html>
            <html lang="es">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
            </head>
            <body style="margin: 0; padding: 0; background-color: #f5f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
              <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f5f7fa;">
                <tr>
                  <td align="center" style="padding: 40px 20px;">
                    <table width="600" cellpadding="0" cellspacing="0" border="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
                      
                      <!-- Header con logo -->
                      <tr>
                        <td style="background: linear-gradient(135deg, #34a853 0%, #1e8e3e 100%); padding: 30px; text-align: center;">
                          <img src="https://res.cloudinary.com/dvrsdqsl1/image/upload/v1764399269/Blue_Minimalist_Technology_Cube_Logo_1_x445ab.png" alt="Logo" style="max-width: 120px; height: auto; margin-bottom: 15px;">
                          <h1 style="color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;">üü¢ Resultados de Pruebas</h1>
                        </td>
                      </tr>
                      
                      <!-- Contenido -->
                      <tr>
                        <td style="padding: 40px 30px;">
                          <p style="color: #333333; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
                            Estimado/a,
                          </p>
                          <p style="color: #555555; font-size: 15px; line-height: 1.6; margin: 0 0 30px 0;">
                            La ejecuci√≥n de pruebas <strong style="color: #34a853;">Karate API</strong> ha finalizado. A continuaci√≥n encontrar√°s el resumen de resultados:
                          </p>
                          
                          <!-- Estado general -->
                          <div style="background: ${{ steps.karate.outputs.karate_failed == 'true' && 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)' || 'linear-gradient(135deg, #34a853 0%, #1e8e3e 100%)' }}; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 30px;">
                            <p style="color: #ffffff; font-size: 18px; font-weight: 600; margin: 0;">
                              Estado: ${{ steps.karate.outputs.karate_failed == 'true' && '‚ùå FALL√ì' || '‚úÖ EXITOSO' }}
                            </p>
                          </div>
                          
                          <!-- Informaci√≥n de ejecuci√≥n -->
                          <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f8f9fa; border-radius: 8px; overflow: hidden; margin-bottom: 30px;">
                            <tr>
                              <td style="padding: 20px;">
                                <table width="100%" cellpadding="8" cellspacing="0" border="0">
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; width: 35%;">üè∑Ô∏è Tag ejecutado:</td>
                                    <td style="color: #34a853; font-size: 14px; font-weight: 600;">${{ steps.setup.outputs.tag }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üåç Ambiente:</td>
                                    <td style="color: #34a853; font-size: 14px; font-weight: 600; padding-top: 10px;">${{ steps.setup.outputs.ambiente }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üìÖ Fecha/Hora:</td>
                                    <td style="color: #333333; font-size: 14px; padding-top: 10px;">${{ steps.fecha_fin.outputs.datetime }}</td>
                                  </tr>
                                  <tr>
                                    <td style="color: #666666; font-size: 14px; font-weight: 600; padding-top: 10px;">üî¢ Ejecuci√≥n #:</td>
                                    <td style="color: #333333; font-size: 14px; padding-top: 10px;">${{ github.run_number }}</td>
                                  </tr>
                                </table>
                              </td>
                            </tr>
                          </table>
                          
                          <!-- Resumen de escenarios -->
                          <h3 style="color: #333333; font-size: 18px; margin: 0 0 15px 0; border-bottom: 2px solid #34a853; padding-bottom: 10px;">
                            üìä Resumen de Escenarios
                          </h3>
                          <div style="overflow-x: auto; margin-bottom: 30px;">
                            ${{ steps.table.outputs.summary_table }}
                          </div>
                          
                          <!-- Bot√≥n de acci√≥n -->
                          <table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin: 30px 0;">
                            <tr>
                              <td align="center">
                                <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/karate-summary.html" style="background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%); color: #ffffff; text-decoration: none; padding: 14px 28px; border-radius: 6px; font-weight: 600; font-size: 15px; display: inline-block; box-shadow: 0 2px 8px rgba(26,115,232,0.3);">
                                  üåê Ver Reporte Completo
                                </a>
                              </td>
                            </tr>
                          </table>
                          
                          <!-- Nota informativa -->
                          <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <p style="color: #856404; font-size: 13px; margin: 0; line-height: 1.5;">
                              <strong>üì¶ Nota:</strong> Tambi√©n puedes descargar los artefactos del reporte desde la secci√≥n de artefactos en GitHub Actions.
                            </p>
                          </div>
                          
                          <p style="color: #555555; font-size: 14px; line-height: 1.6; margin: 20px 0 0 0;">
                            Saludos cordiales,<br>
                            <strong style="color: #34a853;">Sistema Autom√°tico de QA</strong>
                          </p>
                        </td>
                      </tr>
                      
                      <!-- Footer -->
                      <tr>
                        <td style="background-color: #f8f9fa; padding: 20px 30px; border-top: 1px solid #e0e0e0;">
                          <p style="color: #999999; font-size: 12px; margin: 0; text-align: center;">
                            GitHub Actions ¬∑ Testing Continuo ¬∑ ${{ steps.fecha_fin.outputs.year }}
                          </p>
                          <p style="color: #999999; font-size: 11px; margin: 10px 0 0 0; text-align: center;">
                            <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" style="color: #1a73e8; text-decoration: none;">Ver Historial de Reportes</a>
                          </p>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </body>
            </html>