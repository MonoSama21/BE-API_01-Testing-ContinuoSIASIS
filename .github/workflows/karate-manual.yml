name: üöÄ Karate API Tests - Manual

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de pruebas a ejecutar (ej: @login, @security)"
        required: true
        type: string
      ambiente:
        description: "Ambiente a ejecutar (DEV o QA)"
        required: true
        type: choice
        options:
          - DEV
          - QA
        default: QA
      correo:
        description: "Correo donde llegar√°n las notificaciones"
        required: true
        type: string

jobs:
  run-karate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:

      - name: üì• Checkout del repositorio
        uses: actions/checkout@v4

      - name: ‚òï Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ‚úâÔ∏è Notificar INICIO de ejecuci√≥n
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üîµ Inicio de ejecuci√≥n Karate ‚Äì Tag: ${{ github.event.inputs.tag }}"
          body: |
            Hola,

            Se iniciar√° la ejecuci√≥n de pruebas Karate.
            ‚Ä¢ Tag: ${{ github.event.inputs.tag }}
            ‚Ä¢ Ambiente: ${{ github.event.inputs.ambiente }}
            ‚Ä¢ Fecha/Hora: $(date)

            Te notificar√© nuevamente al finalizar las pruebas.

      - name: üì¶ Instalar dependencias
        run: mvn clean install -DskipTests

      - name: üß™ Ejecutar pruebas Karate con tag
        id: karate
        run: |
          echo "karate_failed=false" >> $GITHUB_OUTPUT
          mvn test -Dkarate.options="--tags ${{ github.event.inputs.tag }}" -Dkarate.env=${{ github.event.inputs.ambiente }} || echo "karate_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: üîç Detectar archivo de resumen Karate
        id: detect
        run: |
          FILE=$(find target -type f -name "karate-summary-json.txt" -o -name "karate-summary.json" | head -n 1)
          if [ -z "$FILE" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ karate-summary-json.txt ni karate-summary.json"
            echo "file_summary=" >> $GITHUB_OUTPUT
          else
            echo "Resumen encontrado en: $FILE"
            echo "file_summary=$FILE" >> $GITHUB_OUTPUT
          fi

      - name: üìù Generar tabla HTML de resultados (desde HTML Karate)
        id: table
        run: |
          REPORT_DIR="target/karate-reports"

          echo "<table border='1' cellspacing='0' cellpadding='6' style='border-collapse:collapse;'>" > table.html
          echo "<tr style='background:#f2f2f2;'><th>Escenario</th><th>Estado</th></tr>" >> table.html

          for f in $(find "$REPORT_DIR" -type f -name "*.html"); do

            # Extrae nombres de escenarios
            sed -n 's/.*scenario-name">\(.*\)<\/.*/\1/p' "$f" > names.txt

            # Extrae estado correcto (class="status passed" o "status failed")
            sed -n 's/.*class="status \([^"]*\)".*/\1/p' "$f" > status.txt

            paste names.txt status.txt | while IFS=$'\t' read -r name status; do
              STATUS_UPPER=$(echo "$status" | tr '[:lower:]' '[:upper:]')

              COLOR="red"
              [[ "$STATUS_UPPER" == "PASSED" ]] && COLOR="green"

              echo "<tr><td>$name</td><td style='color:$COLOR;font-weight:bold;'>$STATUS_UPPER</td></tr>" >> table.html
            done
          done

          rm -f names.txt status.txt || true

          echo "</table>" >> table.html

          SUMMARY=$(cat table.html)
          echo "summary_table<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üìÅ Empaquetar reporte limpio
        run: |
          rm -rf karate-report-package || true
          mkdir karate-report-package

          if [ -d "target/karate-reports" ]; then
            cp -r target/karate-reports/* karate-report-package/
          fi

          find karate-report-package -type f \( -iname "*.jar" -o -iname "*.class" -o -iname "*.exe" -o -iname "*.bat" -o -iname "*.cmd" \) -delete || true

          echo "Contenido final:"
          ls -R karate-report-package

      - name: üì§ Subir reporte como artefacto ZIP √∫nico
        uses: actions/upload-artifact@v4
        with:
          name: karate-report
          path: karate-report-package
          retention-days: 14

      - name: ‚úâÔ∏è Notificar FIN de ejecuci√≥n (con tabla y link)
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üü¢ Resultados Karate ‚Äì Tag: ${{ github.event.inputs.tag }}"
          html_body: |
            <h2>Resultados de pruebas Karate</h2>
            <p><b>Tag:</b> ${{ github.event.inputs.tag }}</p>
            <p><b>Ambiente:</b> ${{ github.event.inputs.ambiente }}</p>
            <p><b>Estado:</b> <strong>${{ steps.karate.outputs.karate_failed == 'true' && 'FAILED ‚ùå' || 'PASSED ‚úÖ' }}</strong></p>
            <h3>Resumen de escenarios</h3>
            ${{ steps.table.outputs.summary_table }}
            <p><b>Fecha/Hora:</b> $(date)</p>
            <p>El reporte detallado est√° disponible como artefacto en GitHub Actions.</p>
