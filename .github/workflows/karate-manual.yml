name: üöÄ Karate API Tests - Manual

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de pruebas a ejecutar (ej: @login, @security)"
        required: true
        type: string
      ambiente:
        description: "Ambiente a ejecutar (DEV o QA)"
        required: true
        type: choice
        options:
          - DEV
          - QA
        default: QA
      correo:
        description: "Correo donde llegar√°n las notificaciones"
        required: true
        type: string

jobs:
  run-karate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:

      # ---------- 1. Checkout ----------
      - name: üì• Checkout del repositorio
        uses: actions/checkout@v4

      # ---------- 2. JDK ----------
      - name: ‚òï Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # ---------- 3. Notificaci√≥n antes ----------
      - name: ‚úâÔ∏è Notificar INICIO de ejecuci√≥n
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üîµ Inicio de ejecuci√≥n Karate ‚Äì Tag: ${{ github.event.inputs.tag }}"
          body: |
            Hola,

            Se iniciar√° la ejecuci√≥n de pruebas Karate.
            ‚Ä¢ Tag: ${{ github.event.inputs.tag }}
            ‚Ä¢ Ambiente: ${{ github.event.inputs.ambiente }}
            ‚Ä¢ Fecha/Hora: $(date)

            Te notificar√© nuevamente al finalizar las pruebas.

      # ---------- 4. Instalar dependencias ----------
      - name: üì¶ Instalar dependencias
        run: mvn clean install -DskipTests

      # ---------- 5. Ejecutar pruebas ----------
      - name: üß™ Ejecutar pruebas Karate con tag
        id: karate
        run: |
          echo "karate_failed=false" >> $GITHUB_OUTPUT
          mvn test -Dkarate.options="--tags ${{ github.event.inputs.tag }}" -Dkarate.env=${{ github.event.inputs.ambiente }} || echo "karate_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      # ---------- 6. Detectar archivo JSON de resumen ----------
      - name: üîç Detectar archivo de resumen Karate
        id: detect
        run: |
          FILE=$(find target -name "karate-summary-json.txt" | head -n 1)
          if [ -z "$FILE" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ karate-summary-json.txt"
            echo "file_summary=" >> $GITHUB_OUTPUT
          else
            echo "Resumen encontrado en: $FILE"
            echo "file_summary=$FILE" >> $GITHUB_OUTPUT
          fi

      # ---------- 7. Crear Tabla HTML ----------
      - name: üìù Generar tabla HTML de resultados
        id: table
        run: |
          FILE="${{ steps.detect.outputs.file_summary }}"

          # Si no existe el archivo JSON ‚Üí tabla vac√≠a
          if [ -z "$FILE" ]; then
            echo "<p>No se encontr√≥ karate-summary-json.txt. No hay escenarios para mostrar.</p>" > table.html
          else
            echo "<table border='1' cellspacing='0' cellpadding='6'>" > table.html
            echo "<tr><th>Escenario</th><th>Estado</th></tr>" >> table.html

            cat "$FILE" | jq -r '.scenarios[] | [.name, (if .passed then "PASSED" else "FAILED" end)] | @tsv' | \
            while IFS=$'\t' read -r name status; do
              COLOR="red"
              [[ "$status" == "PASSED" ]] && COLOR="green"
              echo "<tr><td>$name</td><td style='color:$COLOR;font-weight:bold;'>$status</td></tr>" >> table.html
            done

            echo "</table>" >> table.html
          fi

          SUMMARY=$(cat table.html)
          echo "summary_table<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ---------- 8. Crear ZIP del reporte ----------
      - name: üìÅ Crear ZIP del reporte Karate
        run: |
          if [ -d "target/karate-reports" ]; then
            cd target/karate-reports
            zip -r ../../karate-report.zip .
          else
            echo "‚ö†Ô∏è No existe la carpeta target/karate-reports"
          fi

      # ---------- 9. Subir artefacto ZIP ----------
      - name: üì§ Subir reporte ZIP como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: karate-report
          path: karate-report.zip
          retention-days: 14

      # ---------- 10. Notificaci√≥n final ----------
      - name: ‚úâÔ∏è Notificar FIN de ejecuci√≥n (sin adjuntos)
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "üü¢ Resultados Karate ‚Äì Tag: ${{ github.event.inputs.tag }}"
          html_body: |
            <h2>Resultados de pruebas Karate</h2>
            <p><b>Tag:</b> ${{ github.event.inputs.tag }}</p>
            <p><b>Ambiente:</b> ${{ github.event.inputs.ambiente }}</p>
            <p><b>Estado:</b> <strong>
              ${{ steps.karate.outputs.karate_failed == 'true' && 'FAILED ‚ùå' || 'PASSED ‚úÖ' }}
            </strong></p>
            <h3>Resumen de escenarios</h3>
            ${{ steps.table.outputs.summary_table }}
            <p><b>Fecha/Hora:</b> $(date)</p>
            <p>El reporte detallado est√° disponible como artefacto en GitHub Actions.</p>
