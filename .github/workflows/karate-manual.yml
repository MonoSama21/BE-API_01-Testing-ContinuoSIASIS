name: ğŸš€ Karate API Tests - Manual

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag de pruebas a ejecutar (ej: @login, @security)"
        required: true
        type: string
      ambiente:
        description: "Ambiente a ejecutar (DEV o QA)"
        required: true
        type: choice
        options:
          - DEV
          - QA
        default: QA
      correo:
        description: "Correo donde llegarÃ¡n las notificaciones"
        required: true
        type: string

jobs:
  run-karate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:

      # ---------- 1. Checkout ----------
      - name: ğŸ“¥ Checkout del repositorio
        uses: actions/checkout@v4

      # ---------- 2. JDK ----------
      - name: â˜• Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # ---------- 3. NotificaciÃ³n antes ----------
      - name: âœ‰ï¸ Notificar INICIO de ejecuciÃ³n
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "ğŸ”µ Inicio de ejecuciÃ³n Karate â€“ Tag: ${{ github.event.inputs.tag }}"
          body: |
            Hola,

            Se iniciarÃ¡ la ejecuciÃ³n de pruebas Karate.
            â€¢ Tag: ${{ github.event.inputs.tag }}
            â€¢ Ambiente: ${{ github.event.inputs.ambiente }}
            â€¢ Fecha/Hora: $(date)

            Te notificarÃ© nuevamente al finalizar las pruebas.

      # ---------- 4. Instalar dependencias ----------
      - name: ğŸ“¦ Instalar dependencias
        run: mvn clean install -DskipTests

      # ---------- 5. Ejecutar pruebas ----------
      - name: ğŸ§ª Ejecutar pruebas Karate con tag
        id: karate
        run: |
          echo "karate_failed=false" >> $GITHUB_OUTPUT
          mvn test -Dkarate.options="--tags ${{ github.event.inputs.tag }}" -Dkarate.env=${{ github.event.inputs.ambiente }} || echo "karate_failed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ“¦ Comprimir reportes sin archivos bloqueados por Gmail
        run: |
            mkdir safe-report
            cp target/karate-reports/karate-summary.html safe-report/

            # copiar solo las carpetas necesarias
            if [ -d "target/karate-reports/karate-summary" ]; then
            cp -r target/karate-reports/karate-summary safe-report/
            fi

            # Crear ZIP sin archivos ejecutables
            zip -r karate-report.zip safe-report/ \
            -x "*.jar" \
            -x "*.class" \
            -x "*.exe" \
            -x "*.sh" \
            -x "*.bat" \
            -x "*.cmd" \
            -x "*.json" \
            -x "*.js"


      # 7. Subir ZIP como artefacto
      - name: ğŸ“¤ Subir reporte ZIP como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: karate-report
          path: karate-report.zip
          retention-days: 14

      # ---------- 9. NotificaciÃ³n final ----------
      - name: âœ‰ï¸ Notificar FIN de ejecuciÃ³n + Adjuntar reporte
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ github.event.inputs.correo }}
          from: ${{ secrets.MAIL_USERNAME }}
          subject: "ğŸŸ¢ Resultados Karate â€“ Tag: ${{ github.event.inputs.tag }}"
          html_body: |
            <h2>Resultados de pruebas Karate</h2>
            <p><b>Tag:</b> ${{ github.event.inputs.tag }}</p>
            <p><b>Ambiente:</b> ${{ github.event.inputs.ambiente }}</p>
            <p><b>Estado:</b> <strong>
              ${{ steps.karate.outputs.karate_failed == 'true' && 'FAILED âŒ' || 'PASSED âœ…' }}
            </strong></p>
            <p><b>Fecha/Hora:</b> $(date)</p>
            <p>Se adjunta el reporte detallado de pruebas.</p>
          attachments: karate-report.zip